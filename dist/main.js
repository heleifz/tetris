!function(t){var e={};function i(s){if(e[s])return e[s].exports;var o=e[s]={i:s,l:!1,exports:{}};return t[s].call(o.exports,o,o.exports,i),o.l=!0,o.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)i.d(s,o,function(e){return t[e]}.bind(null,o));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="./dist/",i(i.s=8)}([function(t,e,i){var s=i(1),o=i(2);"string"==typeof(o=o.__esModule?o.default:o)&&(o=[[t.i,o,""]]);var n={insert:"head",singleton:!1};s(o,n);t.exports=o.locals||{}},function(t,e,i){"use strict";var s,o=function(){return void 0===s&&(s=Boolean(window&&document&&document.all&&!window.atob)),s},n=function(){var t={};return function(e){if(void 0===t[e]){var i=document.querySelector(e);if(window.HTMLIFrameElement&&i instanceof window.HTMLIFrameElement)try{i=i.contentDocument.head}catch(t){i=null}t[e]=i}return t[e]}}(),l=[];function h(t){for(var e=-1,i=0;i<l.length;i++)if(l[i].identifier===t){e=i;break}return e}function r(t,e){for(var i={},s=[],o=0;o<t.length;o++){var n=t[o],r=e.base?n[0]+e.base:n[0],c=i[r]||0,a="".concat(r," ").concat(c);i[r]=c+1;var u=h(a),d={css:n[1],media:n[2],sourceMap:n[3]};-1!==u?(l[u].references++,l[u].updater(d)):l.push({identifier:a,updater:k(d,e),references:1}),s.push(a)}return s}function c(t){var e=document.createElement("style"),s=t.attributes||{};if(void 0===s.nonce){var o=i.nc;o&&(s.nonce=o)}if(Object.keys(s).forEach((function(t){e.setAttribute(t,s[t])})),"function"==typeof t.insert)t.insert(e);else{var l=n(t.insert||"head");if(!l)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");l.appendChild(e)}return e}var a,u=(a=[],function(t,e){return a[t]=e,a.filter(Boolean).join("\n")});function d(t,e,i,s){var o=i?"":s.media?"@media ".concat(s.media," {").concat(s.css,"}"):s.css;if(t.styleSheet)t.styleSheet.cssText=u(e,o);else{var n=document.createTextNode(o),l=t.childNodes;l[e]&&t.removeChild(l[e]),l.length?t.insertBefore(n,l[e]):t.appendChild(n)}}function f(t,e,i){var s=i.css,o=i.media,n=i.sourceMap;if(o?t.setAttribute("media",o):t.removeAttribute("media"),n&&btoa&&(s+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(n))))," */")),t.styleSheet)t.styleSheet.cssText=s;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(s))}}var p=null,g=0;function k(t,e){var i,s,o;if(e.singleton){var n=g++;i=p||(p=c(e)),s=d.bind(null,i,n,!1),o=d.bind(null,i,n,!0)}else i=c(e),s=f.bind(null,i,e),o=function(){!function(t){if(null===t.parentNode)return!1;t.parentNode.removeChild(t)}(i)};return s(t),function(e){if(e){if(e.css===t.css&&e.media===t.media&&e.sourceMap===t.sourceMap)return;s(t=e)}else o()}}t.exports=function(t,e){(e=e||{}).singleton||"boolean"==typeof e.singleton||(e.singleton=o());var i=r(t=t||[],e);return function(t){if(t=t||[],"[object Array]"===Object.prototype.toString.call(t)){for(var s=0;s<i.length;s++){var o=h(i[s]);l[o].references--}for(var n=r(t,e),c=0;c<i.length;c++){var a=h(i[c]);0===l[a].references&&(l[a].updater(),l.splice(a,1))}i=n}}}},function(t,e,i){var s=i(3),o=i(4),n=i(5),l=i(6),h=i(7);e=s(!1);var r=o(n),c=o(l),a=o(h);e.push([t.i,"@font-face { font-family: pixeboy; src: url("+r+"); } \n@font-face { font-family: ka1; src: url("+c+"); } \nhtml, body {\n    margin: 0 !important;\n    padding: 0 !important;\n}\nbody {\n    background: #000000;\n    /* Prevent the ugly blue highlighting from accidental selection of text */ user-select: none;\n    -webkit-touch-callout: none !important;\n    -webkit-user-select: none !important;\n    -khtml-user-select: none !important; /* Konqueror HTML */\n    -moz-user-select: none !important; /* Old versions of Firefox */\n    -ms-user-select: none !important; /* Internet Explorer/Edge */\n\n    overflow: hidden;\n    top: 0; bottom: 0; left: 0; right: 0;\n    \n}\n@media only screen and (min-width: 800px)\n{\n    #wrapper {\n        position: absolute; \n        top: 0; bottom: 0; left: 0; right: 0;\n        background-image: url("+a+");\n        background-size: 100% 100%;\n    }\n}\n@media only screen and (max-width: 800px)\n{\n    /* 小屏幕背景图 */\n    #wrapper {\n        position: absolute; \n        top: 0; bottom: 0; left: 0; right: 0;\n        background-image: url("+a+");\n        background-size: cover;\n    }\n}",""]),t.exports=e},function(t,e,i){"use strict";t.exports=function(t){var e=[];return e.toString=function(){return this.map((function(e){var i=function(t,e){var i=t[1]||"",s=t[3];if(!s)return i;if(e&&"function"==typeof btoa){var o=(l=s,h=btoa(unescape(encodeURIComponent(JSON.stringify(l)))),r="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(h),"/*# ".concat(r," */")),n=s.sources.map((function(t){return"/*# sourceURL=".concat(s.sourceRoot||"").concat(t," */")}));return[i].concat(n).concat([o]).join("\n")}var l,h,r;return[i].join("\n")}(e,t);return e[2]?"@media ".concat(e[2]," {").concat(i,"}"):i})).join("")},e.i=function(t,i,s){"string"==typeof t&&(t=[[null,t,""]]);var o={};if(s)for(var n=0;n<this.length;n++){var l=this[n][0];null!=l&&(o[l]=!0)}for(var h=0;h<t.length;h++){var r=[].concat(t[h]);s&&o[r[0]]||(i&&(r[2]?r[2]="".concat(i," and ").concat(r[2]):r[2]=i),e.push(r))}},e}},function(t,e,i){"use strict";t.exports=function(t,e){return e||(e={}),"string"!=typeof(t=t&&t.__esModule?t.default:t)?t:(/^['"].*['"]$/.test(t)&&(t=t.slice(1,-1)),e.hash&&(t+=e.hash),/["'() \t\n]/.test(t)||e.needQuotes?'"'.concat(t.replace(/"/g,'\\"').replace(/\n/g,"\\n"),'"'):t)}},function(t,e,i){"use strict";i.r(e),e.default=i.p+"143c9dc71d2a56d4bc46c33e06440ebc.ttf"},function(t,e,i){"use strict";i.r(e),e.default=i.p+"5df8cd545dcd2db2bf8b3093ddd428e3.ttf"},function(t,e,i){"use strict";i.r(e),e.default=i.p+"c1c53ea6dd632d9b0f1ffb7d371cd86a.jpg"},function(t,e,i){"use strict";i.r(e);i(0);var s=i.p+"153c34eacbc748a364e3523688261f90.png";function o(t){let e=null,i=null,s=null,o=null;for(let n of t){const t=n[0],l=n[1];(null==e||t<e)&&(e=t),(null==i||t>i)&&(i=t),(null==s||l<s)&&(s=l),(null==o||l>o)&&(o=l)}return[e,i,s,o]}class n{constructor(t,e,i){this.shapes=t,this.style=i,this.kickTable=null,"other"==e?this.kickTable={0:{1:[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],3:[[0,0],[1,0],[1,1],[0,-2],[1,-2]]},1:{2:[[0,0],[1,0],[1,-1],[0,2],[1,2]],0:[[0,0],[1,0],[1,-1],[0,2],[1,2]]},2:{3:[[0,0],[1,0],[1,1],[0,-2],[1,-2]],1:[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]]},3:{0:[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]],2:[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]]}}:"I"==e&&(this.kickTable={0:{1:[[0,0],[-2,0],[1,0],[-2,-1],[1,2]],3:[[0,0],[-1,0],[2,0],[-1,2],[2,-1]]},1:{2:[[0,0],[-1,0],[2,0],[-1,2],[2,-1]],0:[[0,0],[2,0],[-1,0],[2,1],[-1,-2]]},2:{3:[[0,0],[2,0],[-1,0],[2,1],[-1,-2]],1:[[0,0],[1,0],[-2,0],[1,-2],[-2,1]]},3:{0:[[0,0],[1,0],[-2,0],[1,-2],[-2,1]],2:[[0,0],[-2,0],[1,0],[-2,-1],[1,2]]}}),this.offsets=[],this.boundingBoxWidth=t[0][1].length;for(let e=0;e<t.length;++e){const i=t[e],s=[];for(let t=0;t<i.length;++t)for(let e=0;e<i[t].length;++e)1==i[t][e]&&s.push([t,e]);this.offsets.push(s)}}getRotationNumber(t){let e;return e=t<0?(4- -t%4)%4:t%4,e}positions(t,e,i){let s=this.getRotationNumber(i);const o=this.offsets[s];let n=[];for(let i=0;i<o.length;++i){let s=o[i];n.push([t+s[0],e+s[1]])}return n}collide(t,e,i,s){const o=this.positions(e,i,s);for(let e=0;e<o.length;++e){const i=o[e];if(i[0]<0||i[1]<0||i[0]>=t.length||i[1]>=t[i[0]].length)return!0;if(null!==t[i[0]][i[1]])return!0}return!1}rotate(t,e,i,s,o){const n=this.getRotationNumber(s),l=this.getRotationNumber(s+o);if(null==this.kickTable)return this.collide(t,e,i,l)?[e,i,n]:[e,i,l];const h=this.kickTable[n][l];for(let s in h){const o=h[s];if(!this.collide(t,e-o[1],i+o[0],l))return[e-o[1],i+o[0],l]}return[e,i,n]}move(t,e,i,s,o){let n=e,l=i,h=s;if("clockwise"==o)return this.rotate(t,e,i,s,1);if("counter_clockwise"==o)return this.rotate(t,e,i,s,-1);if("left"==o)l-=1;else if("right"==o)l+=1;else if("down"==o)n+=1;else if("hard_drop"==o){let o=this.positions(e,i,s),l=t.length-1;for(let e=0;e<o.length;++e){let i=o[e][1],s=o[e][0];l=Math.min(l,t.length-s-1);for(let e=s+1;e<t.length;++e)if(null!==t[e][i]){let t=e-s-1;l=Math.min(t,l);break}}n+=l}return this.collide(t,n,l,h)?[e,i,s]:[n,l,h]}}let l=new n([[[1,0,0],[1,1,1],[0,0,0]],[[0,1,1],[0,1,0],[0,1,0]],[[0,0,0],[1,1,1],[0,0,1]],[[0,1,0],[0,1,0],[1,1,0]]],"other","blue"),h=new n([[[1,1,0],[0,1,1],[0,0,0]],[[0,0,1],[0,1,1],[0,1,0]],[[0,0,0],[1,1,0],[0,1,1]],[[0,1,0],[1,1,0],[1,0,0]]],"other","red"),r=new n([[[0,0,1],[1,1,1],[0,0,0]],[[0,1,0],[0,1,0],[0,1,1]],[[0,0,0],[1,1,1],[1,0,0]],[[1,1,0],[0,1,0],[0,1,0]]],"other","orange"),c=new n([[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],[[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]],[[0,0,0,0],[0,0,0,0],[1,1,1,1],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]]],"I","cyan"),a=new n([[[0,1,1,0],[0,1,1,0],[0,0,0,0]],[[0,1,1,0],[0,1,1,0],[0,0,0,0]],[[0,1,1,0],[0,1,1,0],[0,0,0,0]],[[0,1,1,0],[0,1,1,0],[0,0,0,0]]],null,"yellow"),u=new n([[[0,1,0],[1,1,1],[0,0,0]],[[0,1,0],[0,1,1],[0,1,0]],[[0,0,0],[1,1,1],[0,1,0]],[[0,1,0],[1,1,0],[0,1,0]]],"other","purple"),d=new n([[[0,1,1],[1,1,0],[0,0,0]],[[0,1,0],[0,1,1],[0,0,1]],[[0,0,0],[0,1,1],[1,1,0]],[[1,0,0],[1,1,0],[0,1,0]]],"other","green");class f{onGameEvent(t){}keyControl(t,e){if(!(t in this.keyMap))return;const i=this.keyMap[t];if("down"==e){let t=1;if(i in this.keyPressed&&1==this.keyPressed[i]&&(t=0),this.callback(i),this.keyPressed[i]=1,("left"==i||"right"==i||"down"==i)&&t){const t=this;clearTimeout(this.keyTimer[i]),this.keyTimer[i]=setTimeout((function e(){1==t.keyPressed[i]&&(t.callback(i),setTimeout(e,30))}),250)}}else this.keyPressed[i]=0,clearTimeout(this.keyTimer[i]),this.keyTimer[i]=null}install(t){this.keyPressed={},this.keyTimer={},this.callback=t,this.keyMap={ArrowLeft:"left",ArrowRight:"right",ArrowDown:"down",ArrowUp:"clockwise",Space:"hard_drop",MetaLeft:"hold"};let e=this;document.addEventListener("keydown",t=>{e.keyControl(t.code,"down")}),document.addEventListener("keyup",t=>{e.keyControl(t.code,"up")})}}class p{onGameEvent(t){"lockblock"==t&&this.clearTouch()}clearTouch(){this.ongoingTouches=[],this.touchNoMove=[],this.ongoingTouchesStart=[],this.touchTrace=[],this.ongoingTouchesTime=[]}indexForOngoingTouch(t){const e=t.identifier;for(let t=0;t<this.ongoingTouches.length;t++)if(this.ongoingTouches[t].identifier==e)return t;return null}onTouchStart(t,e){e("touch");var i=t.changedTouches;for(let t=0;t<i.length;t++){let e=i[t];this.ongoingTouches.push(e),this.ongoingTouchesStart.push(e),this.touchNoMove.push(!0),this.touchTrace.push([]),this.ongoingTouchesTime.push(Date.now())}}onTouchMove(t,e){var i=t.changedTouches;for(let t=0;t<i.length;t++){let s=i[t];const o=this.indexForOngoingTouch(s);if(null!=o){const t=s.pageY-this.ongoingTouches[o].pageY,i=s.pageX-this.ongoingTouches[o].pageX;let n=null;Math.abs(i)>Math.abs(t)&&i<-18?n="left":Math.abs(i)>Math.abs(t)&&i>18?n="right":Math.abs(t)>Math.abs(i)&&t>18&&(n="down"),null!==n&&(this.ongoingTouches[o]=s,this.touchNoMove[o]=!1,e(n));const l=Date.now();this.touchTrace[o].push([l-this.ongoingTouchesTime[o],[i,t]]),this.ongoingTouchesTime[o]=l}}}onTouchEnd(t,e){var i=t.changedTouches;for(let t=0;t<i.length;t++){let s=i[t];const o=this.indexForOngoingTouch(s);if(null!=o){const t=s.pageY-this.ongoingTouchesStart[o].pageY,i=s.pageX-this.ongoingTouchesStart[o].pageX;if(Math.abs(i)<=18&&Math.abs(t)<=18&&this.touchNoMove[o])e("clockwise");else{let t=0,i=[0,0],s=[0,0],n=0;for(let e=this.touchTrace[o].length-1;e>=0;e--)if(s[0]+=this.touchTrace[o][e][1][0],s[1]+=this.touchTrace[o][e][1][1],n+=this.touchTrace[o][e][0],n>0){let e=Math.sqrt(s[0]**2+s[1]**2)/n;e>t&&(t=e,i[0]=s[0],i[1]=s[1])}t>1.2&&Math.abs(i[1])>Math.abs(i[0])&&i[1]>1.3*18?e("hard_drop"):t>1.2&&i[1]<-36&&Math.abs(i[1])>Math.abs(i[0])&&e("regret")}this.ongoingTouches.splice(o),this.touchNoMove.splice(o),this.ongoingTouchesStart.splice(o),this.touchTrace.splice(o),this.ongoingTouchesTime.splice(o)}}}install(t){this.clearTouch();const e=this;document.addEventListener("touchstart",i=>{e.onTouchStart(i,t)}),document.addEventListener("touchmove",i=>{e.onTouchMove(i,t)}),document.addEventListener("touchend",i=>{e.onTouchEnd(i,t)}),document.addEventListener("touchcancel",i=>{e.onTouchEnd(i,t)})}}class g{constructor(t){this.startLevel=t,this.onLevelUp=null,this.reset()}reset(){this.score=0,this.combo=0,this.regretCount=0,this.lineCount=0,this.level=this.startLevel,this.levelClearCount=0}dropSpeed(){return 1e3*Math.pow(.8-.007*(this.level-1),this.level-1)}onLevelUp(t){this.onLevelUp=t}regret(){return this.regretCount>0&&(this.regretCount-=1,!0)}onDrop(t,e){"soft"==e?this.score+=t:"hard"==e&&(this.score+=2*t)}onLock(t){t&&(this.score+=400*this.level),this.combo=0}onClearLine(t,e,i){if(0==t)return;this.combo+=1,this.lineCount+=t,this.levelClearCount+=t;let s=0;s=i?[null,800,1200,1600,null][t]:[null,100,300,500,800][t],e&&(s+=[null,800,1e3,1800,200][t]),s*=this.level,this.combo>1&&(s+=this.level*(this.combo-1)*50),4==t&&(this.regretCount+=1),this.levelClearCount>10&&(this.level+=1,this.levelClearCount-=10,null!==this.onLevelUp&&this.onLevelUp(this.level))}}var k=i.p+"adabb7de6ea9690077c9facc7da0de0f.wav",b=i.p+"bfb42860c69139288dcfac52dc6d9f60.wav",m=i.p+"6919a781914917848bb778a8174fbb00.wav",w=i.p+"26b8654f97b08c024ba4cf4f34d7b4f7.wav",v=i.p+"b56c7b6aa88cf7dab52b4fc0fd854627.mp3";class y{async loadResource(){window.AudioContext=window.AudioContext||window.webkitAudioContext,this.audioContext=new AudioContext,this.bgmReady=!1,this.audio={};let t=await Promise.all([this.loadSoundBuffer(k),this.loadSoundBuffer(b),this.loadSoundBuffer(m),this.loadSoundBuffer(w),this.loadSoundBuffer(v)]);this.audio.clockwise=t[0],this.audio.left=t[1],this.audio.right=this.audio.left,this.audio.down=this.audio.left,this.audio.hard_drop=t[2],this.audio.clear_line=t[3],this.audio.bgm=t[4],this.bgm=null}loadSoundBuffer(t){let e=this.audioContext;return new Promise((i,s)=>{var o=new XMLHttpRequest;o.open("GET",t,!0),o.responseType="arraybuffer",o.onload=function(){e.decodeAudioData(o.response,(function(t){i(t)}),(function(){s()}))},o.send()})}playAudioBuffer(t,e,i){this.audioContext.resume();var s=this.audioContext.createBufferSource();s.buffer=t;let o=this.audioContext.createGain();o.gain.setValueAtTime(e,this.audioContext.currentTime),s.connect(o),o.connect(this.audioContext.destination),!0===i&&(s.loop=!0),s.start(0)}playBgmAtFirstTime(t){null===this.bgm&&(this.playAudioBuffer(this.audio.bgm,.3,!0),this.bgm=t)}play(t){t in this.audio&&this.playAudioBuffer(this.audio[t],.2)}}const x=22,C=10,T=7;class S{constructor(t,e,i,s,o){this.colorPosition={red:0,blue:1,yellow:2,green:3,cyan:4,orange:5,purple:6,gray:7},this.context=s,this.virtualRows=x+2,this.rows=x,this.cols=C,this.relocate(t,e,i,o),this.clearAll()}clearAll(){this.stack=this.createEmptyStack(),this.block=null,this.blockRow=null,this.blockCol=null,this.tspin=!1,this.rotation=null,this.predicted=null;for(let t=0;t<this.virtualRows;t++)for(let e=0;e<this.cols;e++)this.dirtyMap[t][e]=!0}cannotFall(){return!(null==this.block||!this.block.collide(this.stack,this.blockRow+1,this.blockCol,this.rotation))}spawnNewBlock(t){this.markBlockDirty(),this.markPredictDirty(),this.block=t;const e=Math.floor(this.cols/2),i=this.block.boundingBoxWidth;return this.blockRow=1,this.blockCol=e-Math.ceil(i/2),this.rotation=0,this.block.collide(this.stack,this.blockRow,this.blockCol,this.rotation)?(this.block=null,this.predicted=null,this.blockCol=null,this.blockRow=null,this.rotation=null,!1):(this.predicted=this.hardDropPosition(),this.markBlockDirty(),this.markPredictDirty(),!0)}move(t){if(this.tspin=!1,null==this.block)return null;this.markBlockDirty(),"clockwise"!=t&&"counter_clockwise"!=t&&"left"!=t&&"right"!=t||this.markPredictDirty();const e=this.block.move(this.stack,this.blockRow,this.blockCol,this.rotation,t),i=e[0]-this.blockRow,s=e[0],o=e[1],n=e[2];let l="normal";if(s==this.blockRow&&o==this.blockCol&&n==this.rotation)l="stuck";else if(("clockwise"==t||"counter_clockwise"==t)&&this.block==u){let t=[[s,o],[s+2,o],[s,o+2],[s+2,o+2]],e=0;for(let i of t)i[0]<0||i[0]>=this.virtualRows||i[1]<0||i[1]>=this.cols||null!=this.stack[i[0]][i[1]]&&(e+=1);e>=3&&(l="tspin",this.tspin=!0)}return this.blockRow=s,this.blockCol=o,this.rotation=n,"clockwise"!=t&&"counter_clockwise"!=t&&"left"!=t&&"right"!=t||(this.predicted=this.hardDropPosition(),this.markPredictDirty()),this.markBlockDirty(),{newRow:s,newCol:o,newRotation:n,dropStep:i,moveType:l}}TSpin(){return this.tspin}currentBlock(){return this.block}getFullLines(){let t=[],e=!0;for(let i=0;i<this.virtualRows;i++)this.stack[i].every(t=>null!==t)?t.push(i):e=!1;return[t,e]}lockBlock(){let t=this.block.positions(this.blockRow,this.blockCol,this.rotation);for(let e of t)this.stack[e[0]][e[1]]=this.block.style;this.block=null,this.predicted=null,this.blockRow=null,this.blockCol=null,this.rotation=null}hardDropPosition(){if(null==this.block)return null;const t=this.block.move(this.stack,this.blockRow,this.blockCol,this.rotation,"hard_drop");return this.block.positions(t[0],t[1],t[2])}markStackAreaDirty(){let t=0;t:for(let e=0;e<this.virtualRows;e++)for(let i=0;i<this.cols;++i)if(null!==this.stack[e][i]){t=e;break t}for(let e=t;e<this.virtualRows;e++)for(let t=0;t<this.cols;++t)this.dirtyMap[e][t]=!0}clearLines(t){this.markStackAreaDirty(),t.sort();for(let e=t.length-1;e>=0;e--)this.stack.splice(t[e],1);for(let e=0;e<t.length;e++){let t=new Array(this.cols);for(let e=0;e<this.cols;++e)t[e]=null;this.stack.unshift(t)}}markPredictDirty(){if(null!==this.block)for(let t of this.predicted)this.dirtyMap[t[0]][t[1]]=!0}markBlockDirty(){if(null===this.block)return;const t=this.block.positions(this.blockRow,this.blockCol,this.rotation);for(let e of t)this.dirtyMap[e[0]][e[1]]=!0}createEmptyStack(){let t=[];for(let e=0;e<this.virtualRows;e++){let e=new Array(this.cols);for(let t=0;t<this.cols;++t)e[t]=null;t.push(e)}return t}relocate(t,e,i,s){this.x=t,this.y=e,this.blockSize=i,this.blockImage=s,this.dirtyMap=[];for(let t=0;t<this.virtualRows;t++){let t=new Array(this.cols);for(let e=0;e<this.cols;e++)t[e]=!0;this.dirtyMap.push(t)}}draw(){if(null!=this.block){for(let t of this.predicted)this.dirtyMap[t[0]][t[1]]&&(this.clearBlock(t[0],t[1]),this.drawBlock(t[0],t[1],this.block.style,.3));const t=this.block.positions(this.blockRow,this.blockCol,this.rotation);for(let e of t)this.dirtyMap[e[0]][e[1]]&&(this.drawBlock(e[0],e[1],this.block.style,1),this.dirtyMap[e[0]][e[1]]=!1);for(let t of this.predicted)this.dirtyMap[t[0]][t[1]]&&(this.dirtyMap[t[0]][t[1]]=!1)}for(let t=0;t<this.virtualRows;t++)for(let e=0;e<this.cols;e++)this.dirtyMap[t][e]&&(this.clearBlock(t,e),null!=this.stack[t][e]&&this.drawBlock(t,e,this.stack[t][e],1),this.dirtyMap[t][e]=!1)}clearBlock(t,e){if(t<2)return;const i=e*this.blockSize+this.x,s=(t-2)*this.blockSize+this.y;this.context.clearRect(i,s,this.blockSize,this.blockSize)}drawBlock(t,e,i,s){if(t<2)return;const o=e*this.blockSize+this.x,n=(t-2)*this.blockSize+this.y,l=this.colorPosition[i];this.context.save(),s<1&&(this.context.globalAlpha=s),this.context.drawImage(this.blockImage,l*this.blockSize,0,this.blockSize,this.blockSize,o,n,this.blockSize,this.blockSize),this.context.restore()}}class M{constructor(t,e,i,s,o,n,l){this.uiContext=n,this.textContext=l,this.title=o,this.relocate(t,e,i,s)}relocate(t,e,i,s){this.x=t,this.y=e,this.width=i,this.height=s,this.textDirty=!0,this.uiDirty=!0}draw(){this.uiDirty&&(this.uiContext.clearRect(this.x,this.y,this.width,this.height),this.uiContext.save(),this.uiContext.fillStyle="rgb(0,0,0,0.85)",this.uiContext.fillRect(this.x,this.y,this.width,this.height),this.uiContext.restore(),this.uiDirty=!1),this.textDirty&&(this.textContext.save(),this.textContext.clearRect(this.x,this.y,this.width,this.height),this.textContext.fillStyle="white",this.textContext.font=this.height+1+"px pixeboy",this.textContext.fillText(this.title,this.x,this.y+this.height),this.textContext.restore(),this.textDirty=!1)}}class B{constructor(t,e,i,s,o,n,l,h,r){this.titleBar=new M(t,e,i,o,n,h,r),this.content=l,this.uiContext=h,this.textContext=r,this.relocate(t,e,i,s,o)}setContent(t){t!=this.content&&(this.content=t,this.contentDirty=!0)}relocate(t,e,i,s,o){this.x=t,this.y=e,this.width=i,this.height=s,this.titleHeight=o,this.uiDirty=!0,this.contentDirty=!0,this.titleBar.relocate(t,e,i,o)}draw(){this.titleBar.draw(),this.uiDirty&&(this.uiContext.clearRect(this.x,this.y+this.titleHeight,this.width,this.height-this.titleHeight),this.uiContext.save(),this.uiContext.fillStyle="rgb(0,0,0,0.6)",this.uiContext.fillRect(this.x,this.y+this.titleHeight,this.width,this.height-this.titleHeight),this.uiContext.restore(),this.uiDirty=!1),this.contentDirty&&(this.textContext.save(),this.textContext.fillStyle="white",this.textContext.clearRect(this.x,this.y+this.titleHeight,this.width,this.height-this.titleHeight),this.textContext.font=this.calculateFontSize(this.content)+"px ka1",this.textContext.fillText(this.content,this.x+2,this.y+2*this.titleHeight),this.contentDirty=!1,this.textContext.restore())}calculateFontSize(t){const e=this.textContext;let i=this.titleHeight-3;for(;i>3;){if(e.font=i+"px ka1",e.measureText(t).width+5<this.width)break;i-=1}return i}}class R{constructor(){this.dpr=window.devicePixelRatio||1,this.uiCanvas=document.getElementById("ui"),this.spriteCanvas=document.getElementById("game"),this.animationCanvas=document.getElementById("animation"),this.virutalCanvas=document.createElement("canvas")}getUiContext(){return this.uiCanvas.getContext("2d")}getSpriteContext(){return this.spriteCanvas.getContext("2d")}getAnimationContext(){return this.animationCanvas.getContext("2d")}getVirtualCanvas(){return this.virutalCanvas}getViewPort(){this.setUpAllCanvas();window.innerWidth,this.dpr,window.innerHeight,this.dpr;const t=(i=" -webkit- -moz- -o- -ms- ".split(" "),!!("ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch)||(e=["(",i.join("touch-enabled),("),"heartz",")"].join(""),window.matchMedia(e).matches));var e,i;return{width:this.uiCanvas.width,height:this.uiCanvas.height,isTouch:t,dpr:this.dpr}}clearAll(){const t=this.spriteCanvas.width,e=this.spriteCanvas.height;this.getSpriteContext().clearRect(0,0,t,e),this.getUiContext().clearRect(0,0,t,e),this.getAnimationContext().clearRect(0,0,t,e)}setUpAllCanvas(){this.uiCanvas=this.setUpCanvas(this.uiCanvas),this.spriteCanvas=this.setUpCanvas(this.spriteCanvas),this.animationCanvas=this.setUpCanvas(this.animationCanvas)}setUpCanvas(t){let e=+getComputedStyle(t).getPropertyValue("height").slice(0,-2),i=+getComputedStyle(t).getPropertyValue("width").slice(0,-2);return t.height=e*this.dpr,t.width=i*this.dpr,t}}class P{constructor(t,e,i,s,o,n){this.context=n,this.relocate(t,e,i,s,o)}relocate(t,e,i,s,o){this.x=t,this.y=e,this.width=i,this.height=s,this.blockSize=o,this.dirty=!0}draw(){if(this.dirty){const t=this.context;t.save(),t.fillStyle="rgb(0,0,0,0.8)",t.fillRect(this.x,this.y,this.width,this.height),t.strokeStyle="rgb(60,60,60)",t.lineWidth=2,t.beginPath();for(let e=1;e<C;++e)t.moveTo(this.x+e*this.blockSize,this.y),t.lineTo(this.x+e*this.blockSize,this.height+this.y);for(let e=1;e<x;++e)t.moveTo(this.x,this.y+e*this.blockSize),t.lineTo(this.x+this.width,this.y+e*this.blockSize);t.stroke(),t.restore(),this.dirty=!1}}}class D{constructor(t,e,i,s,o,n,l,h,r,c,a){this.colorPosition={red:0,blue:1,yellow:2,green:3,cyan:4,orange:5,purple:6,gray:7},this.panel=new B(t,e,i,s,o,n,"",c,a),this.title=n,this.uiContext=c,this.spriteContext=a,this.relocate(t,e,i,s,o,h,r),this.setBlocks(l)}setBlocks(t){let e=!1;if(this.blocks&&t.length==this.blocks.length){for(let i=0;i<this.blocks.length;i++)if(console.log(t[i],this.blocks[i]),t[i]!=this.blocks[i]){e=!0;break}}else e=!0;if(e){this.blocks=[];for(let e of t)this.blocks.push(e);this.blockDirty=!0}}relocate(t,e,i,s,o,n,l){this.panel.relocate(t,e,i,s,o),this.x=t,this.y=e,this.width=i,this.height=s,this.titleHeight=o,this.blockImage=n,this.imageBlockSize=l,this.blockDirty=!0}draw(){this.panel.draw(),this.blockDirty&&(this.spriteContext.save(),this.spriteContext.clearRect(this.x,this.y+this.titleHeight,this.width,this.height-this.titleHeight),this.drawBlocks(),this.blockDirty=!1,this.spriteContext.restore())}drawBlocks(){const t=Math.round(.8*this.width/4),e=Math.round((this.height-this.titleHeight)/this.blocks.length*.85/2),i=Math.min(t,e),s=Math.round((this.height-this.titleHeight)/this.blocks.length);for(let t=0;t<this.blocks.length;t++){const e=this.blocks[t],n=e.positions(0,0,0),[l,h,r,c]=o(n),a=(c-r+1)*i,u=(h-l+1)*i,d=Math.round((this.width-a)/2),f=Math.round((s-u)/2),p=this.colorPosition[e.style],g=this.x,k=this.y+this.titleHeight+t*s;for(let t=0;t<n.length;++t){let e=(n[t][1]-r)*i+g+d,s=(n[t][0]-l)*i+k+f;this.spriteContext.drawImage(this.blockImage,p*this.imageBlockSize,0,this.imageBlockSize,this.imageBlockSize,e,s,i,i)}}}}const F={lockDelay:500};class A{constructor(t){this.candidates=[l,h,r,c,a,u,d],this.state="begin",this.inputs=[],this.nextBlocks=[],this.hold=null,this.holdTime=0,this.scoreRule=new g(1),this.beginTime=null,this.endTime=null,this.config=t,this.storage=window.localStorage,this.canvas=new R,this.sound=new y,this.sprites=[],this.blockField=null}installInput(t){const e=this;t.install((function(t){e.control(t)})),this.inputs.push(t)}getScoreRank(){let t=this.storage.getItem("score_rank");return null==t?[]:JSON.parse(t)}addToScoreRank(t,e,i){let s=this.getScoreRank(),o=(n=new Date,l=n.getHours(),h=n.getMinutes(),r=l+":"+(h=h<10?"0"+h:h),n.getFullYear()+"/"+(n.getMonth()+1)+"/"+n.getDate()+"  "+r);var n,l,h,r;s.push({score:t,useTime:e,clearLine:i,playedAt:o}),s.sort((t,e)=>t.score>e.score||t.score==e.score&&t.playedAt>e.playedAt?-1:e.score>t.score||t.score==e.score&&e.playedAt>t.playedAt?1:0),s.length>10&&(s=s.slice(0,10)),this.storage.setItem("score_rank",JSON.stringify(s))}initializeSprites(){const t=this.canvas.getViewPort();this.canvas.clearAll();const e=Math.round(1.4*C)/x;let i,s=!1;t.height*e<t.width?i=Math.round(.95*t.height/x):(i=Math.round(.95*t.width/1.4/C),s=!0);let o=this.canvas.getVirtualCanvas();o.height=i,o.width=i*T,o.getContext("2d").drawImage(this.blockImage,0,0,i*T,i);const n=i*C,l=i*x,h=Math.round((t.width-1.4*n)/2);let r;r=s&&t.isTouch?Math.round((t.height-l)/7):Math.round((t.height-l)/2),this.board=new P(h,r,n,l,i,this.canvas.getUiContext()),null==this.blockField?this.blockField=new S(h,r,i,this.canvas.getSpriteContext(),o):this.blockField.relocate(h,r,i,o);const c=Math.round(l/30),a=h+n,u=Math.round(.4*n),d=r,f=Math.round(.33*t.height);this.previewPanel=new D(a,d,u,f+c,c,"next",this.nextBlocks,o,i,this.canvas.getUiContext(),this.canvas.getSpriteContext());const p=d+c+f,g=Math.round(.05*t.height);this.scorePanel=new B(a,p,u,g+c,c,"score",this.scoreRule.score,this.canvas.getUiContext(),this.canvas.getSpriteContext());const k=p+c+g;this.clearLinePanel=new B(a,k,u,g+c,c,"lines",this.scoreRule.lineCount,this.canvas.getUiContext(),this.canvas.getSpriteContext());const b=k+c+g;this.timePanel=new B(a,b,u,g+c,c,"time",this.getUsedTime(),this.canvas.getUiContext(),this.canvas.getSpriteContext());const m=b+g+c;this.regretPanel=new B(a,m,u,g+c,c,"regret",this.scoreRule.regretCount,this.canvas.getUiContext(),this.canvas.getSpriteContext());const w=m+g+c,v=Math.round(.15*t.height);this.holdPanel=new D(a,w,u,v+c,c,"hold",null==this.hold?[]:[this.hold],o,i,this.canvas.getUiContext(),this.canvas.getSpriteContext()),this.sprites=[this.blockField,this.board,this.scorePanel,this.clearLinePanel,this.timePanel,this.regretPanel,this.previewPanel,this.holdPanel]}drawSprites(){for(let t of this.sprites)t.draw()}getUsedTime(){let t=0;if(null!==this.beginTime&&null==this.endTime){t=Date.now()-this.beginTime}else null!=this.endTime&&(t=this.endTime-this.beginTime);return function(t){parseInt(t%1e3/100);let e=Math.floor(t/1e3%60),i=Math.floor(t/6e4%60),s=Math.floor(t/36e5%24);return s=s<10?"0"+s:s,i=i<10?"0"+i:i,e=e<10?"0"+e:e,s+":"+i+":"+e}(t)}run(){this.resetFallTimer();const t=this;!function e(){t.timePanel.setContent(t.getUsedTime()),t.drawSprites(),requestAnimationFrame(e)}()}stopFallTimer(){clearTimeout(this.fallTimerId)}resetFallTimer(){this.stopFallTimer();const t=this.scoreRule.dropSpeed(),e=this;this.fallTimerId=setTimeout((function(){e.stateMachine("fall"),e.resetFallTimer()}),t)}newDrop(){this.state="restart";const t=this;setTimeout((function(){t.stateMachine("fall")}),150)}lockBlock(){for(let t of this.inputs)t.onGameEvent("lockblock");this.stopFallTimer(),this.blockField.lockBlock();const t=this.blockField.getFullLines();t[0].length>0?(this.sound.play("clear_line"),this.scoreRule.onClearLine(t[0].length,t[1],this.blockField.TSpin()),this.blockField.clearLines(t[0]),this.scorePanel.setContent(this.scoreRule.score),this.clearLinePanel.setContent(this.scoreRule.lineCount),this.regretPanel.setContent(this.scoreRule.regretCount),this.newDrop()):(this.scoreRule.onLock(this.blockField.TSpin()),this.scorePanel.setContent(this.scoreRule.score),this.newDrop())}resetDelayTimer(){clearTimeout(this.lockDelayTimer);const t=this;this.lockDelayTimer=setTimeout((function(){t.blockField.cannotFall()&&t.lockBlock()}),this.config.lockDelay)}pickBlock(){if(0==this.randomBlocks.length){for(let t in this.candidates)this.randomBlocks.push(this.candidates[t]);!function(t){for(let e=t.length-1;e>0;e--){let i=Math.floor(Math.random()*(e+1)),s=t[e];t[e]=t[i],t[i]=s}}(this.randomBlocks)}return this.randomBlocks.shift()}stateMachine(t){if("begin"==this.state)this.scoreRule.reset(),this.randomBlocks=[],this.hold=null,this.holdTime=0,this.state="dropping",this.beginTime=Date.now(),this.endTime=null,this.blockField.spawnNewBlock(this.pickBlock()),this.nextBlocks=[this.pickBlock(),this.pickBlock(),this.pickBlock()],this.previewPanel.setBlocks(this.nextBlocks),this.holdPanel.setBlocks([]),this.resetDelayTimer();else if("dropping"==this.state&&"hold"!=t&&"regret"!=t){let e=null;"down"==t?e="soft":"hard_drop"==t&&(e="hard"),"fall"==t&&(t="down");const i=this.blockField.move(t);"stuck"!=i.moveType&&(this.resetDelayTimer(),"down"==t&&null==e||this.blockField.currentBlock()==a&&"clockwise"==t||this.sound.play(t)),this.scoreRule.onDrop(i.dropStep,e),this.scorePanel.setContent(this.scoreRule.score),"hard_drop"==t&&this.lockBlock()}else if("dropping"==this.state&&"hold"==t)if(0==this.holdTime){let t;if(null==this.hold)this.hold=this.blockField.currentBlock(),t=this.nextBlocks.shift(),this.nextBlocks.push(this.pickBlock()),this.previewPanel.setBlocks(this.nextBlocks),this.holdPanel.setBlocks([this.hold]);else{let e=this.blockField.currentBlock();t=this.hold,this.hold=e,this.holdPanel.setBlocks([this.hold])}this.blockField.spawnNewBlock(t),this.resetDelayTimer(),this.holdTime=1}else console.log("cannot hold two times");else if("dropping"==this.state&&"regret"==t)this.scoreRule.regret()?(this.blockField.spawnNewBlock(this.blockField.currentBlock()),this.resetDelayTimer(),this.regretPanel.setContent(this.scoreRule.regretCount)):console.log("cannot regret");else if("restart"==this.state)this.resetDelayTimer(),this.resetFallTimer(),this.holdTime=0,this.nextBlocks.push(this.pickBlock()),this.blockField.spawnNewBlock(this.nextBlocks.shift())?(this.previewPanel.setBlocks(this.nextBlocks),this.state="dropping","fall"!=t&&this.stateMachine(t)):(this.state="over",this.stateMachine("over"));else if("over"==this.state)"over"==t?this.blockField.clearAll():"fall"!=t&&(this.state="begin");else if("pause_game"==this.state)return}control(t){this.sound.playBgmAtFirstTime(this.scoreRule.level),t in{left:1,right:1,down:1,clockwise:1,counter_clockwise:1,hard_drop:1,hold:1,regret:1}&&this.stateMachine(t)}async loadImages(){var t;this.blockImage=await(t=s,new Promise((function(e){const i=new Image;i.src=t,i.onload=function(){e(i)}})))}async loadResource(){return Promise.all([this.loadImages(),this.sound.loadResource()])}}window.addEventListener("load",(function(){let t=new A(F);t.loadResource().then((function(){t.initializeSprites(),t.installInput(new f),t.installInput(new p),t.run()})),window.addEventListener("resize",(function(){t.initializeSprites()}))}))}]);