!function(t){var e={};function i(s){if(e[s])return e[s].exports;var n=e[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(s,n,function(e){return t[e]}.bind(null,n));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="./dist/",i(i.s=8)}([function(t,e,i){var s=i(1),n=i(2);"string"==typeof(n=n.__esModule?n.default:n)&&(n=[[t.i,n,""]]);var o={insert:"head",singleton:!1};s(n,o);t.exports=n.locals||{}},function(t,e,i){"use strict";var s,n=function(){return void 0===s&&(s=Boolean(window&&document&&document.all&&!window.atob)),s},o=function(){var t={};return function(e){if(void 0===t[e]){var i=document.querySelector(e);if(window.HTMLIFrameElement&&i instanceof window.HTMLIFrameElement)try{i=i.contentDocument.head}catch(t){i=null}t[e]=i}return t[e]}}(),l=[];function h(t){for(var e=-1,i=0;i<l.length;i++)if(l[i].identifier===t){e=i;break}return e}function r(t,e){for(var i={},s=[],n=0;n<t.length;n++){var o=t[n],r=e.base?o[0]+e.base:o[0],a=i[r]||0,c="".concat(r," ").concat(a);i[r]=a+1;var u=h(c),d={css:o[1],media:o[2],sourceMap:o[3]};-1!==u?(l[u].references++,l[u].updater(d)):l.push({identifier:c,updater:m(d,e),references:1}),s.push(c)}return s}function a(t){var e=document.createElement("style"),s=t.attributes||{};if(void 0===s.nonce){var n=i.nc;n&&(s.nonce=n)}if(Object.keys(s).forEach((function(t){e.setAttribute(t,s[t])})),"function"==typeof t.insert)t.insert(e);else{var l=o(t.insert||"head");if(!l)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");l.appendChild(e)}return e}var c,u=(c=[],function(t,e){return c[t]=e,c.filter(Boolean).join("\n")});function d(t,e,i,s){var n=i?"":s.media?"@media ".concat(s.media," {").concat(s.css,"}"):s.css;if(t.styleSheet)t.styleSheet.cssText=u(e,n);else{var o=document.createTextNode(n),l=t.childNodes;l[e]&&t.removeChild(l[e]),l.length?t.insertBefore(o,l[e]):t.appendChild(o)}}function f(t,e,i){var s=i.css,n=i.media,o=i.sourceMap;if(n?t.setAttribute("media",n):t.removeAttribute("media"),o&&btoa&&(s+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(o))))," */")),t.styleSheet)t.styleSheet.cssText=s;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(s))}}var g=null,p=0;function m(t,e){var i,s,n;if(e.singleton){var o=p++;i=g||(g=a(e)),s=d.bind(null,i,o,!1),n=d.bind(null,i,o,!0)}else i=a(e),s=f.bind(null,i,e),n=function(){!function(t){if(null===t.parentNode)return!1;t.parentNode.removeChild(t)}(i)};return s(t),function(e){if(e){if(e.css===t.css&&e.media===t.media&&e.sourceMap===t.sourceMap)return;s(t=e)}else n()}}t.exports=function(t,e){(e=e||{}).singleton||"boolean"==typeof e.singleton||(e.singleton=n());var i=r(t=t||[],e);return function(t){if(t=t||[],"[object Array]"===Object.prototype.toString.call(t)){for(var s=0;s<i.length;s++){var n=h(i[s]);l[n].references--}for(var o=r(t,e),a=0;a<i.length;a++){var c=h(i[a]);0===l[c].references&&(l[c].updater(),l.splice(c,1))}i=o}}}},function(t,e,i){var s=i(3),n=i(4),o=i(5),l=i(6),h=i(7);e=s(!1);var r=n(o),a=n(l),c=n(h);e.push([t.i,"@font-face { font-family: pixeboy; src: url("+r+"); } \n@font-face { font-family: ka1; src: url("+a+"); } \nhtml, body {\n    margin: 0 !important;\n    padding: 0 !important;\n}\nbody {\n    background: #000000;\n    /* Prevent the ugly blue highlighting from accidental selection of text */ user-select: none;\n    -webkit-touch-callout: none !important;\n    -webkit-user-select: none !important;\n    -khtml-user-select: none !important; /* Konqueror HTML */\n    -moz-user-select: none !important; /* Old versions of Firefox */\n    -ms-user-select: none !important; /* Internet Explorer/Edge */\n\n    overflow: hidden;\n    top: 0; bottom: 0; left: 0; right: 0;\n    \n}\n@media only screen and (min-width: 800px)\n{\n    #wrapper {\n        position: absolute; \n        top: 0; bottom: 0; left: 0; right: 0;\n        background-image: url("+c+");\n        background-size: 100% 100%;\n    }\n}\n@media only screen and (max-width: 800px)\n{\n    /* 小屏幕背景图 */\n    #wrapper {\n        position: absolute; \n        top: 0; bottom: 0; left: 0; right: 0;\n        background-image: url("+c+");\n        background-size: cover;\n    }\n}",""]),t.exports=e},function(t,e,i){"use strict";t.exports=function(t){var e=[];return e.toString=function(){return this.map((function(e){var i=function(t,e){var i=t[1]||"",s=t[3];if(!s)return i;if(e&&"function"==typeof btoa){var n=(l=s,h=btoa(unescape(encodeURIComponent(JSON.stringify(l)))),r="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(h),"/*# ".concat(r," */")),o=s.sources.map((function(t){return"/*# sourceURL=".concat(s.sourceRoot||"").concat(t," */")}));return[i].concat(o).concat([n]).join("\n")}var l,h,r;return[i].join("\n")}(e,t);return e[2]?"@media ".concat(e[2]," {").concat(i,"}"):i})).join("")},e.i=function(t,i,s){"string"==typeof t&&(t=[[null,t,""]]);var n={};if(s)for(var o=0;o<this.length;o++){var l=this[o][0];null!=l&&(n[l]=!0)}for(var h=0;h<t.length;h++){var r=[].concat(t[h]);s&&n[r[0]]||(i&&(r[2]?r[2]="".concat(i," and ").concat(r[2]):r[2]=i),e.push(r))}},e}},function(t,e,i){"use strict";t.exports=function(t,e){return e||(e={}),"string"!=typeof(t=t&&t.__esModule?t.default:t)?t:(/^['"].*['"]$/.test(t)&&(t=t.slice(1,-1)),e.hash&&(t+=e.hash),/["'() \t\n]/.test(t)||e.needQuotes?'"'.concat(t.replace(/"/g,'\\"').replace(/\n/g,"\\n"),'"'):t)}},function(t,e,i){"use strict";i.r(e),e.default=i.p+"143c9dc71d2a56d4bc46c33e06440ebc.ttf"},function(t,e,i){"use strict";i.r(e),e.default=i.p+"5df8cd545dcd2db2bf8b3093ddd428e3.ttf"},function(t,e,i){"use strict";i.r(e),e.default=i.p+"c1c53ea6dd632d9b0f1ffb7d371cd86a.jpg"},function(t,e,i){"use strict";i.r(e);var s=i.p+"adabb7de6ea9690077c9facc7da0de0f.wav",n=i.p+"bfb42860c69139288dcfac52dc6d9f60.wav",o=i.p+"6919a781914917848bb778a8174fbb00.wav",l=i.p+"26b8654f97b08c024ba4cf4f34d7b4f7.wav",h=i.p+"b56c7b6aa88cf7dab52b4fc0fd854627.mp3";i(0);class r{constructor(t,e,i){this.shapes=t,this.style=i,this.kickTable=null,"other"==e?this.kickTable={0:{1:[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],3:[[0,0],[1,0],[1,1],[0,-2],[1,-2]]},1:{2:[[0,0],[1,0],[1,-1],[0,2],[1,2]],0:[[0,0],[1,0],[1,-1],[0,2],[1,2]]},2:{3:[[0,0],[1,0],[1,1],[0,-2],[1,-2]],1:[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]]},3:{0:[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]],2:[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]]}}:"I"==e&&(this.kickTable={0:{1:[[0,0],[-2,0],[1,0],[-2,-1],[1,2]],3:[[0,0],[-1,0],[2,0],[-1,2],[2,-1]]},1:{2:[[0,0],[-1,0],[2,0],[-1,2],[2,-1]],0:[[0,0],[2,0],[-1,0],[2,1],[-1,-2]]},2:{3:[[0,0],[2,0],[-1,0],[2,1],[-1,-2]],1:[[0,0],[1,0],[-2,0],[1,-2],[-2,1]]},3:{0:[[0,0],[1,0],[-2,0],[1,-2],[-2,1]],2:[[0,0],[-2,0],[1,0],[-2,-1],[1,2]]}}),this.offsets=[],this.boundingBoxWidth=t[0][1].length;for(let e=0;e<t.length;++e){const i=t[e],s=[];for(let t=0;t<i.length;++t)for(let e=0;e<i[t].length;++e)1==i[t][e]&&s.push([t,e]);this.offsets.push(s)}}getRotationNumber(t){let e;return e=t<0?(4- -t%4)%4:t%4,e}positions(t,e,i){let s=this.getRotationNumber(i);const n=this.offsets[s];let o=[];for(let i=0;i<n.length;++i){let s=n[i];o.push([t+s[0],e+s[1]])}return o}collide(t,e,i,s){const n=this.positions(e,i,s);for(let e=0;e<n.length;++e){const i=n[e];if(i[0]<0||i[1]<0||i[0]>=t.length||i[1]>=t[i[0]].length)return!0;if(null!==t[i[0]][i[1]])return!0}return!1}rotate(t,e,i,s,n){const o=this.getRotationNumber(s),l=this.getRotationNumber(s+n);if(null==this.kickTable)return this.collide(t,e,i,l)?[e,i,o]:[e,i,l];const h=this.kickTable[o][l];for(let s in h){const n=h[s];if(!this.collide(t,e-n[1],i+n[0],l))return[e-n[1],i+n[0],l]}return[e,i,o]}move(t,e,i,s,n){let o=e,l=i,h=s;if("clockwise"==n)return this.rotate(t,e,i,s,1);if("counter_clockwise"==n)return this.rotate(t,e,i,s,-1);if("left"==n)l-=1;else if("right"==n)l+=1;else if("down"==n)o+=1;else if("hard_drop"==n){let n=this.positions(e,i,s),l=t.length-1;for(let e=0;e<n.length;++e){let i=n[e][1],s=n[e][0];l=Math.min(l,t.length-s-1);for(let e=s+1;e<t.length;++e)if(null!==t[e][i]){let t=e-s-1;l=Math.min(t,l);break}}o+=l}return this.collide(t,o,l,h)?[e,i,s]:[o,l,h]}}let a=new r([[[1,0,0],[1,1,1],[0,0,0]],[[0,1,1],[0,1,0],[0,1,0]],[[0,0,0],[1,1,1],[0,0,1]],[[0,1,0],[0,1,0],[1,1,0]]],"other","blue"),c=new r([[[1,1,0],[0,1,1],[0,0,0]],[[0,0,1],[0,1,1],[0,1,0]],[[0,0,0],[1,1,0],[0,1,1]],[[0,1,0],[1,1,0],[1,0,0]]],"other","red"),u=new r([[[0,0,1],[1,1,1],[0,0,0]],[[0,1,0],[0,1,0],[0,1,1]],[[0,0,0],[1,1,1],[1,0,0]],[[1,1,0],[0,1,0],[0,1,0]]],"other","orange"),d=new r([[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],[[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]],[[0,0,0,0],[0,0,0,0],[1,1,1,1],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]]],"I","cyan"),f=new r([[[0,1,1,0],[0,1,1,0],[0,0,0,0]],[[0,1,1,0],[0,1,1,0],[0,0,0,0]],[[0,1,1,0],[0,1,1,0],[0,0,0,0]],[[0,1,1,0],[0,1,1,0],[0,0,0,0]]],null,"yellow"),g=new r([[[0,1,0],[1,1,1],[0,0,0]],[[0,1,0],[0,1,1],[0,1,0]],[[0,0,0],[1,1,1],[0,1,0]],[[0,1,0],[1,1,0],[0,1,0]]],"other","purple"),p=new r([[[0,1,1],[1,1,0],[0,0,0]],[[0,1,0],[0,1,1],[0,0,1]],[[0,0,0],[0,1,1],[1,1,0]],[[1,0,0],[1,1,0],[0,1,0]]],"other","green");function m(t){let e=null,i=null,s=null,n=null;for(let o of t){const t=o[0],l=o[1];(null==e||t<e)&&(e=t),(null==i||t>i)&&(i=t),(null==s||l<s)&&(s=l),(null==n||l>n)&&(n=l)}return[e,i,s,n]}function b(t){parseInt(t%1e3/100);let e=Math.floor(t/1e3%60),i=Math.floor(t/6e4%60),s=Math.floor(t/36e5%24);return s=s<10?"0"+s:s,i=i<10?"0"+i:i,e=e<10?"0"+e:e,s+":"+i+":"+e}function k(t){let e=1;const i=Math.round(7.2),s=18-i;return function(n){const o=Math.round(.015*n.render.height);let l=8;const h=n.render.getAnimationContext();if(t.length>10&&(l=0),e<18){for(let r in t){const a=t[r];let c=n.render.gameX,u=(a-2)*n.render.blockSizeInPixels+n.render.gameY,d=n.render.blockSizeInPixels,f=n.render.gameWidth;if(e<=i){const t=e/i;h.fillStyle="rgba(255,255,255,"+t+")"}else{if(e==i+1)for(let t=0;t<n.stack[a].length;++t)n.stack[a][t]=null;const t=1-(e-i)/s;h.fillStyle="rgba(255,255,255,"+t+")",f*=1-(e-i)/s,c+=(n.render.gameWidth-f)/2;for(let t=0;t<l;++t){let t=v(w(o,n.render),c,u+n.render.blockSizeInPixels/2,90+45*Math.random(),10+5*Math.random(),30,20,40);n.animations.push(t),t=v(w(o,n.render),c+f,u+n.render.blockSizeInPixels/2,45+45*Math.random(),10+5*Math.random(),30,20,40),n.animations.push(t)}}h.fillRect(c,u,f,d)}e+=1}else if(18==e)return null!==n.afterPause&&(n.afterPause(),n.afterPause=null),null}}function v(t,e,i,s,n,o,l,h){let r=0;const a=2*Math.PI-s%360/360*(2*Math.PI);let c=Math.cos(a)*n,u=Math.sin(a)*n;return function(s){let n=1-r/h,a=l*r%360/360*(2*Math.PI);return t(e+c*r,i+u*r+.01*o*(r*r),a,n),r==h?null:(r+=1,1)}}function w(t,e){let i=["rgb(255,29,88)","rgb(24,89,144)","rgb(255,246,133)","rgb(0,221,255)","rgb(0,73,183)"];const s=i[Math.floor(Math.random()*i.length)],n=Math.random()*t;return function(t,i,o,l){const h=e.getAnimationContext();h.save(),h.fillStyle=s,h.globalAlpha=l,h.fillRect(t,i,n,n),h.restore()}}const x=function(){let t=1;return function(e){const i=e.render.getAnimationContext(),s=e.render.windowHeight,n=e.render.width,o=.5*e.render.height*(t/40),l=t/40*.8,h=Math.round(.12*o),r=(s-o)/2*.8;return i.fillStyle="rgba(50,50,50,"+l+")",i.fillRect(0,r,n,o),t>20&&(i.font=h+"px ka1",i.fillStyle="rgba(251,226,81,"+(t-20)/20+")",i.textAlign="center",i.fillText("GAME  OVER",n/2,1.05*r)),t>10&&function(t,e,i,s,n,o,l,h){const r=h.getScoreRank(),a=Math.round(.08*n);t.font=a+"px pixeboy";const c=Math.round(e+s/2);let u=!1;const d=Math.min(10,r.length),f=Math.round(1.27*i);for(let e=0;e<d;++e){let i=r[e];r[e].score==h.score?(u=!0,t.fillStyle="rgba(200,0,0,"+l/o+")"):t.fillStyle="rgba(255,255,255,"+l/o+")",t.textAlign="right",t.fillText(i.score,c-.35*n,f+a*e),t.textAlign="left",t.fillText(i.clearLine,c-.25*n,f+a*e),t.textAlign="left",t.fillText(i.playedAt,c,f+a*e)}u||(t.fillStyle="rgba(200,0,0,"+l/o+")",t.textAlign="right",t.fillText(h.score,c-.35*n,f+a*d),t.textAlign="left",t.fillText(h.clearCount,c-.25*n,f+a*d),t.textAlign="left",t.fillText(formatDate(new Date),c,f+a*d))}(i,0,r,n,o,30,t-10,e),40==t||(t+=1),1}};var y=i.p+"153c34eacbc748a364e3523688261f90.png";class T{constructor(t,e,i,s,n){this.dpr=window.devicePixelRatio||1,this.animationCanvas=t,this.uiCanvas=e,this.canvas=i,this.gamePadCanvas=s,this.config=n,this.virutalCanvas=document.createElement("canvas")}setUpCanvas(t){let e=+getComputedStyle(t).getPropertyValue("height").slice(0,-2),i=+getComputedStyle(t).getPropertyValue("width").slice(0,-2);t.height=e*this.dpr,t.width=i*this.dpr}recalculate(){var t,e;this.isTouch=(e=" -webkit- -moz- -o- -ms- ".split(" "),!!("ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch)||(t=["(",e.join("touch-enabled),("),"heartz",")"].join(""),window.matchMedia(t).matches)),this.animationContext=null,this.gameContext=null,this.width=window.innerWidth*this.dpr,this.windowHeight=window.innerHeight*this.dpr;const i=Math.round(1.4*this.config.columnSize)/this.config.lines;let s=!1;this.windowHeight*i<this.width?this.blockSizeInPixels=Math.round(.95*this.windowHeight/this.config.lines):(this.blockSizeInPixels=Math.round(.95*this.width/i/this.config.lines),s=!0),this.virutalCanvas.height=this.blockSizeInPixels,this.virutalCanvas.width=this.blockSizeInPixels*this.skin.blockTypeNum,this.virutalCanvas.getContext("2d").drawImage(this.skin.image,0,0,this.blockSizeInPixels*this.skin.blockTypeNum,this.blockSizeInPixels),this.gameWidth=this.blockSizeInPixels*this.config.columnSize,this.height=this.blockSizeInPixels*this.config.lines,this.gameX=Math.round((this.width-1.4*this.gameWidth)/2),s&&this.isTouch?this.gameY=Math.round((this.windowHeight-this.height)/7):this.gameY=Math.round((this.windowHeight-this.height)/2),this.setUpCanvas(this.canvas),this.setUpCanvas(this.uiCanvas),this.setUpCanvas(this.animationCanvas),this.setUpCanvas(this.gamePadCanvas),this.titleHeight=Math.round(this.height/30),this.titleX=this.gameX+this.gameWidth,this.titleWidth=Math.round(.4*this.gameWidth),this.previewWindows=[];let n=this.gameY+this.titleHeight,o=Math.round(.11*this.height);for(let t=0;t<3;t++)this.previewWindows.push([this.titleX,n,this.titleWidth,o]),n+=o;this.scoreY=n+this.titleHeight,this.scoreHeight=Math.round(.05*this.height),this.clearLineY=this.scoreY+this.scoreHeight+this.titleHeight,this.clearLineHeight=this.scoreHeight,this.timeY=this.clearLineY+this.scoreHeight+this.titleHeight,this.timeHeight=this.scoreHeight,this.regretY=this.timeY+this.scoreHeight+this.titleHeight,this.regretHeight=this.scoreHeight,this.holdY=this.regretY+this.scoreHeight+this.titleHeight,this.holdHeight=Math.round(1.2*o)}async loadResource(){var t;this.skin={},this.skin.image=await(t=y,new Promise((function(e){const i=new Image;i.src=t,i.onload=function(){e(i)}}))),this.skin.blockTypeNum=7,this.skin.colorPosition={red:0,blue:1,yellow:2,green:3,cyan:4,orange:5,purple:6,gray:7}}getAnimationContext(){return null===this.animationContext&&(this.animationContext=this.animationCanvas.getContext("2d")),this.animationContext}getGameContext(){return null===this.gameContext&&(this.gameContext=this.canvas.getContext("2d")),this.gameContext}clearAnimation(){this.animationCanvas.getContext("2d").clearRect(0,0,this.animationCanvas.width,this.animationCanvas.height)}clearElements(){this.canvas.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height)}drawUI(){const t=this.uiCanvas.getContext("2d");t.fillStyle="rgb(0,0,0,0.8)",t.fillRect(this.gameX,this.gameY,this.gameWidth,this.height),t.strokeStyle="rgb(60,60,60)",t.lineWidth=1,t.beginPath();for(let e=1;e<this.config.columnSize;++e)t.moveTo(this.gameX+e*this.blockSizeInPixels,this.gameY),t.lineTo(this.gameX+e*this.blockSizeInPixels,this.height+this.gameY);for(let e=1;e<this.config.lines;++e)t.moveTo(this.gameX,this.gameY+e*this.blockSizeInPixels),t.lineTo(this.gameX+this.gameWidth,this.gameY+e*this.blockSizeInPixels);t.stroke(),t.fillStyle="rgb(0,0,0,0.85)",t.fillRect(this.titleX,this.gameY,this.titleWidth,this.titleHeight),t.fillStyle="white",t.font=this.titleHeight+1+"px pixeboy",t.fillText("next",this.titleX,this.gameY+this.titleHeight),t.fillStyle="rgb(0,0,0,0.6)";for(let e of this.previewWindows)t.fillRect(e[0],e[1],e[2],e[3]);return t.fillStyle="rgb(0,0,0,0.85)",t.fillRect(this.titleX,this.holdY-this.titleHeight,this.titleWidth,this.titleHeight),t.fillStyle="white",t.font=this.titleHeight+1+"px pixeboy",t.fillText("hold",this.titleX,this.holdY),t.fillStyle="rgb(0,0,0,0.6)",t.fillRect(this.titleX,this.holdY,this.titleWidth,this.holdHeight),t.fillStyle="rgb(0,0,0,0.85)",t.fillRect(this.titleX,this.holdY+this.holdHeight,this.titleWidth,this.titleHeight),t.fillStyle="rgb(0,0,0,0.85)",t.fillRect(this.titleX,this.scoreY-this.titleHeight,this.titleWidth,this.titleHeight),t.fillStyle="white",t.font=this.titleHeight+1+"px pixeboy",t.fillText("score",this.titleX,this.scoreY),t.fillStyle="rgb(0,0,0,0.6)",t.fillRect(this.titleX,this.scoreY,this.titleWidth,this.scoreHeight),t.fillStyle="rgb(0,0,0,0.85)",t.fillRect(this.titleX,this.clearLineY-this.titleHeight,this.titleWidth,this.titleHeight),t.fillStyle="white",t.font=this.titleHeight+1+"px pixeboy",t.fillText("lines",this.titleX,this.clearLineY),t.fillStyle="rgb(0,0,0,0.6)",t.fillRect(this.titleX,this.clearLineY,this.titleWidth,this.clearLineHeight),t.fillStyle="rgb(0,0,0,0.85)",t.fillRect(this.titleX,this.timeY-this.titleHeight,this.titleWidth,this.titleHeight),t.fillStyle="white",t.font=this.titleHeight+1+"px pixeboy",t.fillText("time",this.titleX,this.timeY),t.fillStyle="rgb(0,0,0,0.6)",t.fillRect(this.titleX,this.timeY,this.titleWidth,this.timeHeight),t.fillStyle="rgb(0,0,0,0.85)",t.fillRect(this.titleX,this.regretY-this.titleHeight,this.titleWidth,this.titleHeight),t.fillStyle="white",t.font=this.titleHeight+1+"px pixeboy",t.fillText("redo",this.titleX,this.regretY),t.fillStyle="rgb(0,0,0,0.6)",t.fillRect(this.titleX,this.regretY,this.titleWidth,this.regretHeight),this}drawStats(t,e,i,s,n,o,l){const h=this.canvas.getContext("2d");let r=this.titleHeight-3;for(;r>3;){if(h.font=r+"px ka1",h.measureText(i).width+5<this.titleWidth)break;r-=1}h.fillStyle="white",h.fillText(i,this.titleX+2,this.scoreY+this.titleHeight),h.font=this.titleHeight-7+"px ka1",h.fillText(s,this.titleX+2,this.clearLineY+this.titleHeight),h.fillText(n,this.titleX+2,this.timeY+this.titleHeight),h.fillText(o,this.titleX+2,this.regretY+this.titleHeight),h.font=this.titleHeight+1+"px pixeboy",h.fillText("LEVEL "+l,this.titleX,this.holdY+this.holdHeight+this.titleHeight),this.drawHold(t),this.drawNextBlock(e)}drawBlock(t,e,i,s){if(t<2)return;let n=e*this.blockSizeInPixels+this.gameX,o=(t-2)*this.blockSizeInPixels+this.gameY;const l=this.getGameContext(),h=this.skin.colorPosition[i];l.save(),s<1&&(l.globalAlpha=s),l.drawImage(this.virutalCanvas,h*this.blockSizeInPixels,0,this.blockSizeInPixels,this.blockSizeInPixels,n,o,this.blockSizeInPixels,this.blockSizeInPixels),l.restore()}drawHold(t){if(!t)return;let e=t.positions(0,0,0),[i,s,n,o]=m(e),l=Math.round(.21*this.titleWidth),h=(o-n+1)*l,r=(s-i+1)*l,a=Math.round((this.titleWidth-h)/2),c=Math.round((this.holdHeight-r)/2);const u=this.skin.colorPosition[t.style],d=this.canvas.getContext("2d");for(let t=0;t<e.length;++t){let s=(e[t][1]-n)*l+this.titleX+a,o=(e[t][0]-i)*l+this.holdY+c;d.drawImage(this.virutalCanvas,u*this.blockSizeInPixels,0,this.blockSizeInPixels,this.blockSizeInPixels,s,o,l,l)}}drawNextBlock(t){if(t)for(let e=0;e<t.length&&e<this.previewWindows.length;e++){let i=t[e];if(null===i)continue;let s=this.previewWindows[e],n=i.positions(0,0,0),[o,l,h,r]=m(n),a=Math.round(.21*s[2]),c=(r-h+1)*a,u=(l-o+1)*a,d=Math.round((s[2]-c)/2),f=Math.round((s[3]-u)/2);const g=this.skin.colorPosition[i.style],p=this.canvas.getContext("2d");for(let t=0;t<n.length;++t){let e=(n[t][1]-h)*a+s[0]+d,i=(n[t][0]-o)*a+s[1]+f;p.drawImage(this.virutalCanvas,g*this.blockSizeInPixels,0,this.blockSizeInPixels,this.blockSizeInPixels,e,i,a,a)}}}}class S{onGameEvent(t){}keyControl(t,e){if(!(t in this.keyMap))return;const i=this.keyMap[t];if("down"==e){let t=1;if(i in this.keyPressed&&1==this.keyPressed[i]&&(t=0),this.callback(i),this.keyPressed[i]=1,("left"==i||"right"==i||"down"==i)&&t){const t=this;clearTimeout(this.keyTimer[i]),this.keyTimer[i]=setTimeout((function e(){1==t.keyPressed[i]&&(t.callback(i),setTimeout(e,30))}),250)}}else this.keyPressed[i]=0,clearTimeout(this.keyTimer[i]),this.keyTimer[i]=null}install(t){this.keyPressed={},this.keyTimer={},this.callback=t,this.keyMap={ArrowLeft:"left",ArrowRight:"right",ArrowDown:"down",ArrowUp:"clockwise",Space:"hard_drop",MetaLeft:"hold"};let e=this;document.addEventListener("keydown",t=>{e.keyControl(t.code,"down")}),document.addEventListener("keyup",t=>{e.keyControl(t.code,"up")})}}class M{onGameEvent(t){"lockblock"==t&&this.clearTouch()}clearTouch(){this.ongoingTouches=[],this.touchNoMove=[],this.ongoingTouchesStart=[],this.touchTrace=[],this.ongoingTouchesTime=[]}indexForOngoingTouch(t){const e=t.identifier;for(let t=0;t<this.ongoingTouches.length;t++)if(this.ongoingTouches[t].identifier==e)return t;return null}onTouchStart(t,e){e("touch");var i=t.changedTouches;for(let t=0;t<i.length;t++){let e=i[t];this.ongoingTouches.push(e),this.ongoingTouchesStart.push(e),this.touchNoMove.push(!0),this.touchTrace.push([]),this.ongoingTouchesTime.push(Date.now())}}onTouchMove(t,e){var i=t.changedTouches;for(let t=0;t<i.length;t++){let s=i[t];const n=this.indexForOngoingTouch(s);if(null!=n){const t=s.pageY-this.ongoingTouches[n].pageY,i=s.pageX-this.ongoingTouches[n].pageX;let o=null;Math.abs(i)>Math.abs(t)&&i<-18?o="left":Math.abs(i)>Math.abs(t)&&i>18?o="right":Math.abs(t)>Math.abs(i)&&t>18&&(o="down"),null!==o&&(this.ongoingTouches[n]=s,this.touchNoMove[n]=!1,e(o));const l=Date.now();this.touchTrace[n].push([l-this.ongoingTouchesTime[n],[i,t]]),this.ongoingTouchesTime[n]=l}}}onTouchEnd(t,e){var i=t.changedTouches;for(let t=0;t<i.length;t++){let s=i[t];const n=this.indexForOngoingTouch(s);if(null!=n){const t=s.pageY-this.ongoingTouchesStart[n].pageY,i=s.pageX-this.ongoingTouchesStart[n].pageX;if(Math.abs(i)<=18&&Math.abs(t)<=18&&this.touchNoMove[n])e("clockwise");else{let t=0,i=[0,0],s=[0,0],o=0;for(let e=this.touchTrace[n].length-1;e>=0;e--)if(s[0]+=this.touchTrace[n][e][1][0],s[1]+=this.touchTrace[n][e][1][1],o+=this.touchTrace[n][e][0],o>0){let e=Math.sqrt(s[0]**2+s[1]**2)/o;e>t&&(t=e,i[0]=s[0],i[1]=s[1])}t>1.2&&Math.abs(i[1])>Math.abs(i[0])&&i[1]>1.3*18?e("hard_drop"):t>1.2&&i[1]<-36&&Math.abs(i[1])>Math.abs(i[0])&&e("regret")}this.ongoingTouches.splice(n),this.touchNoMove.splice(n),this.ongoingTouchesStart.splice(n),this.touchTrace.splice(n),this.ongoingTouchesTime.splice(n)}}}install(t){this.clearTouch();const e=this;document.addEventListener("touchstart",i=>{e.onTouchStart(i,t)}),document.addEventListener("touchmove",i=>{e.onTouchMove(i,t)}),document.addEventListener("touchend",i=>{e.onTouchEnd(i,t)}),document.addEventListener("touchcancel",i=>{e.onTouchEnd(i,t)})}}class C{constructor(t){this.startLevel=t,this.onLevelUp=null,this.reset()}reset(){this.score=0,this.combo=0,this.regret=0,this.lineCount=0,this.level=this.startLevel,this.levelClearCount=0}dropSpeed(){return 1e3*Math.pow(.8-.007*(this.level-1),this.level-1)}onLevelUp(t){this.onLevelUp=t}regret(){return this.regret>0&&(this.regret-=1,!0)}onDrop(t,e){"soft"==e?this.score+=t:"hard"==e&&(this.score+=2*t)}onLock(t){null!=t&&(this.score+=400*this.level),this.combo=0}onClearLine(t,e,i){if(0==t)return;this.combo+=1,this.lineCount+=t,this.levelClearCount+=t;let s=0;s=i?[null,800,1200,1600,null][t]:[null,100,300,500,800][t],e&&(s+=[null,800,1e3,1800,200][t]),s*=this.level,this.combo>1&&(s+=this.level*(this.combo-1)*50),t&&(this.regret+=1),this.levelClearCount>10&&(this.level+=1,this.levelClearCount-=10,null!==this.onLevelUp&&this.onLevelUp(this.level))}}let P=document.getElementById("ui"),H=document.getElementById("game"),I=document.getElementById("animation"),R=document.getElementById("gamepad");const z=new class{constructor(t,e,i,s,n,o){this.candidates=[a,c,u,d,f,g,p],this.config=n,this.render=new T(t,e,i,s,n),this.state="begin",this.animations=[],this.inputs=[],this.afterPause=null,this.lastAction=null,this.block=null,this.nextBlocks=[],this.hold=null,this.holdTime=0,this.stack=null,this.scoreRule=null,this.beginTime=null,this.endTime=null,this.storage=o,window.AudioContext=window.AudioContext||window.webkitAudioContext,this.audioContext=new AudioContext,this.bgmReady=!1}installInput(t){const e=this;t.install((function(t){e.control(t)})),this.inputs.push(t)}getScoreRank(){let t=this.storage.getItem("score_rank");return null==t?[]:JSON.parse(t)}addToScoreRank(t,e,i){let s=this.getScoreRank(),n=(o=new Date,l=o.getHours(),h=o.getMinutes(),r=l+":"+(h=h<10?"0"+h:h),o.getFullYear()+"/"+(o.getMonth()+1)+"/"+o.getDate()+"  "+r);var o,l,h,r;s.push({score:t,useTime:e,clearLine:i,playedAt:n}),s.sort((t,e)=>t.score>e.score||t.score==e.score&&t.playedAt>e.playedAt?-1:e.score>t.score||t.score==e.score&&e.playedAt>t.playedAt?1:0),s.length>10&&(s=s.slice(0,10)),this.storage.setItem("score_rank",JSON.stringify(s))}initializeUI(){return this.render.recalculate(),this.render.drawUI(),this}createEmptyStack(t){let e=[];for(let t=0;t<this.config.lines+2;t++){let t=[];for(let e=0;e<this.config.columnSize;++e)t.push(null);e.push(t)}return e}setRule(t){this.scoreRule=t}run(){this.resetFallTimer();const t=this;!function e(){t.drawAllElements(),t.doAnimation(),requestAnimationFrame(e)}()}doAnimation(){this.render.clearAnimation();let t=[];for(let e=0;e<this.animations.length;++e){const i=this.animations[e];null!==i(this)&&t.push(i)}this.animations=t}stopFallTimer(){clearTimeout(this.fallTimerId)}resetFallTimer(){this.stopFallTimer();const t=this.scoreRule.dropSpeed(),e=this;this.fallTimerId=setTimeout((function(){e.stateMachine("fall"),e.resetFallTimer()}),t)}newDrop(){this.state="restart",this.block=null;const t=this;setTimeout((function(){t.stateMachine("fall")}),150)}TSpinType(){if(this.block!=g)return null;if("clockwise"!=this.lastAction&&"counter_clockwise"!=this.lastAction)return null;let t=[this.position,[this.position[0]+2,this.position[1]],[this.position[0],this.position[1]+2],[this.position[0]+2,this.position[1]+2]],e=0;for(let i of t)i[0]<0||i[0]>=this.stack.length||i[1]<0||i[1]>=this.config.columnSize||null!=this.stack[i[0]][i[1]]&&(e+=1);return e>=3?1:null}lockBlock(){if(null==this.block)return;for(let t of this.inputs)t.onGameEvent("lockblock");this.stopFallTimer();let t=this.block.positions(this.position[0],this.position[1],this.rotation);this.animations.push(function(t){let e=1;return function(i){if(!(e<16))return null;{const s=i.render.getAnimationContext();s.save();for(let n in t){const o=t[n];let l=o[1]*i.render.blockSizeInPixels+i.render.gameX,h=(o[0]-2)*i.render.blockSizeInPixels+i.render.gameY;if(e<=8){const t=e/8*.8;s.fillStyle="rgba(255,255,255,"+t+")"}else{const t=.8-(e-8)/7*.8;s.fillStyle="rgba(255,255,255,"+t+")"}s.fillRect(l,h,i.render.blockSizeInPixels,i.render.blockSizeInPixels)}s.restore(),e+=1}}}(t));for(let e=0;e<t.length;++e)this.stack[t[e][0]][t[e][1]]=this.block.style;this.block=null;const e=this.clearLines(),i=this.TSpinType();e[0].length>0?(this.state="pause_game",this.playAudioBuffer(this.audio.clear_line,.2),this.animations.push(k(e[0])),this.afterPause=function(){this.scoreRule.onClearLine(e[0].length,e[2],i),this.stack=e[1],this.newDrop()}):(this.scoreRule.onLock(i),this.newDrop())}clearLines(){let t=[],e=this.createEmptyStack(),i=!0,s=this.stack.length-1;for(let n=this.stack.length-1;n>=0;n--){this.stack[n].every(t=>null!==t)?t.push(n):(e[s]=this.stack[n],i=!1,s-=1)}return[t,e,i]}drawAllElements(){if(this.render.clearElements(),null!==this.block){let t=this.block.positions(this.position[0],this.position[1],this.rotation);for(let e=0;e<t.length;++e)this.render.drawBlock(t[e][0],t[e][1],this.block.style,1)}if("dropping"==this.state&&1==this.config.preview){const t=this.block.move(this.stack,this.position[0],this.position[1],this.rotation,"hard_drop");if(t[0]!=this.position[0]||t[1]!=this.position[1]){let e=this.block.positions(t[0],t[1],t[2]);for(let t=0;t<e.length;++t)this.render.drawBlock(e[t][0],e[t][1],this.block.style,.3)}}if(null!=this.stack)for(let t=0;t<this.stack.length;t++)for(let e=0;e<this.stack[t].length;++e)null!==this.stack[t][e]&&this.render.drawBlock(t,e,this.stack[t][e],1);let t=0;if(null!==this.beginTime&&null==this.endTime){t=Date.now()-this.beginTime}else null!=this.endTime&&(t=this.endTime-this.beginTime);this.render.drawStats(this.hold,this.nextBlocks,this.scoreRule.score,this.scoreRule.lineCount,b(t),this.scoreRule.regret,this.scoreRule.level)}resetDelayTimer(){clearTimeout(this.lockDelayTimer);const t=this;this.lockDelayTimer=setTimeout((function(){null!=t.block&&t.block.collide(t.stack,t.position[0]+1,t.position[1],t.rotation)&&t.lockBlock()}),this.config.lockDelay)}pickBlock(){if(0==this.randomBlocks.length){for(let t in this.candidates)this.randomBlocks.push(this.candidates[t]);!function(t){for(let e=t.length-1;e>0;e--){let i=Math.floor(Math.random()*(e+1)),s=t[e];t[e]=t[i],t[i]=s}}(this.randomBlocks)}return this.randomBlocks.shift()}stateMachine(t){if("begin"==this.state){this.scoreRule.reset(),this.afterPause=null,this.animations=[],this.randomBlocks=[],this.render.clearAnimation(),this.stack=this.createEmptyStack(),this.block=this.pickBlock(),this.nextBlocks=[this.pickBlock(),this.pickBlock(),this.pickBlock()],this.hold=null,this.holdTime=0;const t=Math.floor(this.config.columnSize/2),e=this.block.boundingBoxWidth,i=1,s=t-Math.ceil(e/2);this.resetDelayTimer(),this.position=[i,s],this.rotation=0,this.state="dropping",this.beginTime=Date.now(),this.endTime=null}else if("dropping"==this.state&&"hold"!=t&&"regret"!=t){let e=null;"down"==t?e="soft":"hard_drop"==t&&(e="hard"),"fall"==t&&(t="down");const i=this.block.move(this.stack,this.position[0],this.position[1],this.rotation,t);i[0]==this.position[0]&&i[1]==this.position[1]&&i[2]==this.rotation||(this.resetDelayTimer(),this.lastAction=t,t in this.audio&&("down"==t&&null==e||this.block==f&&"clockwise"==t||this.playAudioBuffer(this.audio[t],.1)));const s=i[0]-this.position[0];if(this.scoreRule.onDrop(s,e),this.position=[i[0],i[1]],this.rotation=i[2],"hard_drop"==t){let t=this.block.positions(this.position[0],this.position[1],this.rotation);this.animations.push(function(t,e){let i=1,[s,n,o,l]=m(t);const h=e.gameX+o*e.blockSizeInPixels,r=e.gameX+(l+1)*e.blockSizeInPixels,a=e.gameY+(s-2)*e.blockSizeInPixels-5;let c=[];if(s>5)for(let t=h;t<=r;t+=20)for(let i=0;i<2;++i){const i=t+30*(.5-Math.random());i<e.gameX+e.gameWidth&&i>e.gameX&&c.push([i,Math.max(e.gameY,a-100-150*Math.random()),6*Math.random(),100*(1-.1*Math.random())])}return function(t){const e=t.render.getAnimationContext();if(!(i<8))return null;for(let t in c){const s=c[t],n=s[1]-i/8*50;let o=e.createLinearGradient(s[0],n,s[0],n+s[3]),l=.7*i/8;o.addColorStop(l,"rgb(80,80,80,0)"),o.addColorStop(.7,"rgb(100,100,100,0.8)"),o.addColorStop(1,"rgb(80,80,80,0)"),e.fillStyle=o,e.fillRect(s[0],n,s[2],s[3])}i+=1}}(t,this.render)),this.lockBlock()}}else if("dropping"==this.state&&"hold"==t)if(0==this.holdTime){if(null==this.hold)this.hold=this.block,this.block=this.nextBlocks.shift(),this.nextBlocks.push(this.pickBlock());else{let t=this.block;this.block=this.hold,this.hold=t}const t=Math.floor(this.config.columnSize/2),e=this.block.boundingBoxWidth,i=1,s=t-Math.ceil(e/2);this.resetDelayTimer(),this.position=[i,s],this.rotation=0,this.holdTime=1}else console.log("cannot hold two times");else if("dropping"==this.state&&"regret"==t)if(this.scoreRule.regret()){const t=Math.floor(this.config.columnSize/2),e=this.block.boundingBoxWidth,i=1,s=t-Math.ceil(e/2);this.resetDelayTimer(),this.position=[i,s],this.rotation=0}else console.log("cannot regret");else if("restart"==this.state){this.holdTime=0,this.block=this.nextBlocks.shift(),this.nextBlocks.push(this.pickBlock());const e=Math.floor(this.config.columnSize/2),i=this.block.boundingBoxWidth,s=1,n=e-Math.ceil(i/2);this.resetDelayTimer(),this.resetFallTimer(),this.position=[s,n],this.rotation=0,this.lastAction=null,this.block.collide(this.stack,this.position[0],this.position[1],this.rotation)?(this.state="over",this.block=null,this.stateMachine("over")):(this.state="dropping","fall"!=t&&this.stateMachine(t))}else if("over"==this.state)if("over"==t){this.endTime=Date.now();let t=[];for(let e=0;e<this.stack.length;++e)t.push(e);this.addToScoreRank(this.score,b(this.endTime-this.beginTime),this.clearCount),this.state="pause_game",this.animations.push(x()),this.animations.push(k(t)),this.afterPause=function(){this.state="over",this.stack=this.createEmptyStack()}}else"fall"!=t&&(this.animations=[],this.render.clearAnimation(),this.state="begin");else if("pause_game"==this.state)return}control(t){z.bgmReady||(z.bgmReady=!0,z.playAudioBuffer(z.audio.bgm,.3,!0)),t in{left:1,right:1,down:1,clockwise:1,counter_clockwise:1,hard_drop:1}&&this.stateMachine(t)}loadSoundBuffer(t){let e=this.audioContext;return new Promise((i,s)=>{var n=new XMLHttpRequest;n.open("GET",t,!0),n.responseType="arraybuffer",n.onload=function(){e.decodeAudioData(n.response,(function(t){i(t)}),(function(){s()}))},n.send()})}playAudioBuffer(t,e,i){var s=this.audioContext.createBufferSource();s.buffer=t;let n=this.audioContext.createGain();n.gain.setValueAtTime(e,this.audioContext.currentTime),s.connect(n),n.connect(this.audioContext.destination),!0===i&&(s.loop=!0),s.start(0)}async loadResource(){await this.render.loadResource(),this.audio={};let t=await Promise.all([this.loadSoundBuffer(s),this.loadSoundBuffer(n),this.loadSoundBuffer(o),this.loadSoundBuffer(l),this.loadSoundBuffer(h)]);this.audio.clockwise=t[0],this.audio.left=t[1],this.audio.right=this.audio.left,this.audio.down=this.audio.left,this.audio.hard_drop=t[2],this.audio.clear_line=t[3],this.audio.bgm=t[4]}}(I,P,H,R,{lines:22,columnSize:10,lockDelay:500,preview:!0},window.localStorage);window.addEventListener("load",(function(){z.loadResource().then((function(){z.initializeUI(),z.setRule(new C(1)),z.installInput(new S),z.installInput(new M),z.run(1)})),window.addEventListener("resize",(function(){z.initializeUI()}))}))}]);