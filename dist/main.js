!function(t){var i={};function e(s){if(i[s])return i[s].exports;var o=i[s]={i:s,l:!1,exports:{}};return t[s].call(o.exports,o,o.exports,e),o.l=!0,o.exports}e.m=t,e.c=i,e.d=function(t,i,s){e.o(t,i)||Object.defineProperty(t,i,{enumerable:!0,get:s})},e.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},e.t=function(t,i){if(1&i&&(t=e(t)),8&i)return t;if(4&i&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(e.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&i&&"string"!=typeof t)for(var o in t)e.d(s,o,function(i){return t[i]}.bind(null,o));return s},e.n=function(t){var i=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(i,"a",i),i},e.o=function(t,i){return Object.prototype.hasOwnProperty.call(t,i)},e.p="./dist/",e(e.s=8)}([function(t,i,e){var s=e(1),o=e(2);"string"==typeof(o=o.__esModule?o.default:o)&&(o=[[t.i,o,""]]);var n={insert:"head",singleton:!1};s(o,n);t.exports=o.locals||{}},function(t,i,e){"use strict";var s,o=function(){return void 0===s&&(s=Boolean(window&&document&&document.all&&!window.atob)),s},n=function(){var t={};return function(i){if(void 0===t[i]){var e=document.querySelector(i);if(window.HTMLIFrameElement&&e instanceof window.HTMLIFrameElement)try{e=e.contentDocument.head}catch(t){e=null}t[i]=e}return t[i]}}(),h=[];function r(t){for(var i=-1,e=0;e<h.length;e++)if(h[e].identifier===t){i=e;break}return i}function l(t,i){for(var e={},s=[],o=0;o<t.length;o++){var n=t[o],l=i.base?n[0]+i.base:n[0],a=e[l]||0,c="".concat(l," ").concat(a);e[l]=a+1;var u=r(c),d={css:n[1],media:n[2],sourceMap:n[3]};-1!==u?(h[u].references++,h[u].updater(d)):h.push({identifier:c,updater:m(d,i),references:1}),s.push(c)}return s}function a(t){var i=document.createElement("style"),s=t.attributes||{};if(void 0===s.nonce){var o=e.nc;o&&(s.nonce=o)}if(Object.keys(s).forEach((function(t){i.setAttribute(t,s[t])})),"function"==typeof t.insert)t.insert(i);else{var h=n(t.insert||"head");if(!h)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");h.appendChild(i)}return i}var c,u=(c=[],function(t,i){return c[t]=i,c.filter(Boolean).join("\n")});function d(t,i,e,s){var o=e?"":s.media?"@media ".concat(s.media," {").concat(s.css,"}"):s.css;if(t.styleSheet)t.styleSheet.cssText=u(i,o);else{var n=document.createTextNode(o),h=t.childNodes;h[i]&&t.removeChild(h[i]),h.length?t.insertBefore(n,h[i]):t.appendChild(n)}}function g(t,i,e){var s=e.css,o=e.media,n=e.sourceMap;if(o?t.setAttribute("media",o):t.removeAttribute("media"),n&&btoa&&(s+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(n))))," */")),t.styleSheet)t.styleSheet.cssText=s;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(s))}}var f=null,p=0;function m(t,i){var e,s,o;if(i.singleton){var n=p++;e=f||(f=a(i)),s=d.bind(null,e,n,!1),o=d.bind(null,e,n,!0)}else e=a(i),s=g.bind(null,e,i),o=function(){!function(t){if(null===t.parentNode)return!1;t.parentNode.removeChild(t)}(e)};return s(t),function(i){if(i){if(i.css===t.css&&i.media===t.media&&i.sourceMap===t.sourceMap)return;s(t=i)}else o()}}t.exports=function(t,i){(i=i||{}).singleton||"boolean"==typeof i.singleton||(i.singleton=o());var e=l(t=t||[],i);return function(t){if(t=t||[],"[object Array]"===Object.prototype.toString.call(t)){for(var s=0;s<e.length;s++){var o=r(e[s]);h[o].references--}for(var n=l(t,i),a=0;a<e.length;a++){var c=r(e[a]);0===h[c].references&&(h[c].updater(),h.splice(c,1))}e=n}}}},function(t,i,e){var s=e(3),o=e(4),n=e(5),h=e(6),r=e(7);i=s(!1);var l=o(n),a=o(h),c=o(r);i.push([t.i,"@font-face { font-family: pixeboy; src: url("+l+"); } \n@font-face { font-family: ka1; src: url("+a+"); } \nhtml, body {\n    margin: 0 !important;\n    padding: 0 !important;\n}\nbody {\n    background: #000000;\n    /* Prevent the ugly blue highlighting from accidental selection of text */ user-select: none;\n    -webkit-touch-callout: none !important;\n    -webkit-user-select: none !important;\n    -khtml-user-select: none !important; /* Konqueror HTML */\n    -moz-user-select: none !important; /* Old versions of Firefox */\n    -ms-user-select: none !important; /* Internet Explorer/Edge */\n\n    overflow: hidden;\n    top: 0; bottom: 0; left: 0; right: 0;\n    \n}\n@media only screen and (min-width: 800px)\n{\n    #wrapper {\n        position: absolute; \n        top: 0; bottom: 0; left: 0; right: 0;\n        background-image: url("+c+");\n        background-size: 100% 100%;\n    }\n}\n@media only screen and (max-width: 800px)\n{\n    /* 小屏幕背景图 */\n    #wrapper {\n        position: absolute; \n        top: 0; bottom: 0; left: 0; right: 0;\n        background-image: url("+c+");\n        background-size: cover;\n    }\n}",""]),t.exports=i},function(t,i,e){"use strict";t.exports=function(t){var i=[];return i.toString=function(){return this.map((function(i){var e=function(t,i){var e=t[1]||"",s=t[3];if(!s)return e;if(i&&"function"==typeof btoa){var o=(h=s,r=btoa(unescape(encodeURIComponent(JSON.stringify(h)))),l="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(r),"/*# ".concat(l," */")),n=s.sources.map((function(t){return"/*# sourceURL=".concat(s.sourceRoot||"").concat(t," */")}));return[e].concat(n).concat([o]).join("\n")}var h,r,l;return[e].join("\n")}(i,t);return i[2]?"@media ".concat(i[2]," {").concat(e,"}"):e})).join("")},i.i=function(t,e,s){"string"==typeof t&&(t=[[null,t,""]]);var o={};if(s)for(var n=0;n<this.length;n++){var h=this[n][0];null!=h&&(o[h]=!0)}for(var r=0;r<t.length;r++){var l=[].concat(t[r]);s&&o[l[0]]||(e&&(l[2]?l[2]="".concat(e," and ").concat(l[2]):l[2]=e),i.push(l))}},i}},function(t,i,e){"use strict";t.exports=function(t,i){return i||(i={}),"string"!=typeof(t=t&&t.__esModule?t.default:t)?t:(/^['"].*['"]$/.test(t)&&(t=t.slice(1,-1)),i.hash&&(t+=i.hash),/["'() \t\n]/.test(t)||i.needQuotes?'"'.concat(t.replace(/"/g,'\\"').replace(/\n/g,"\\n"),'"'):t)}},function(t,i,e){"use strict";e.r(i),i.default=e.p+"143c9dc71d2a56d4bc46c33e06440ebc.ttf"},function(t,i,e){"use strict";e.r(i),i.default=e.p+"5df8cd545dcd2db2bf8b3093ddd428e3.ttf"},function(t,i,e){"use strict";e.r(i),i.default=e.p+"c1c53ea6dd632d9b0f1ffb7d371cd86a.jpg"},function(t,i,e){"use strict";e.r(i);var s=e.p+"adabb7de6ea9690077c9facc7da0de0f.wav",o=e.p+"bfb42860c69139288dcfac52dc6d9f60.wav",n=e.p+"6919a781914917848bb778a8174fbb00.wav",h=e.p+"26b8654f97b08c024ba4cf4f34d7b4f7.wav",r=e.p+"b56c7b6aa88cf7dab52b4fc0fd854627.mp3";class l{async load(){window.AudioContext=window.AudioContext||window.webkitAudioContext,this.audioContext=new AudioContext,this.bgmReady=!1,this.audio={};let t=await Promise.all([this.loadSoundBuffer(s),this.loadSoundBuffer(o),this.loadSoundBuffer(n),this.loadSoundBuffer(h),this.loadSoundBuffer(r)]);this.audio.clockwise=t[0],this.audio.left=t[1],this.audio.right=this.audio.left,this.audio.down=this.audio.left,this.audio.hard_drop=t[2],this.audio.clear_line=t[3],this.audio.bgm=t[4],this.bgm=null}loadSoundBuffer(t){let i=this.audioContext;return new Promise((e,s)=>{var o=new XMLHttpRequest;o.open("GET",t,!0),o.responseType="arraybuffer",o.onload=function(){i.decodeAudioData(o.response,(function(t){e(t)}),(function(){s()}))},o.send()})}playAudioBuffer(t,i,e){this.audioContext.resume();var s=this.audioContext.createBufferSource();s.buffer=t;let o=this.audioContext.createGain();o.gain.setValueAtTime(i,this.audioContext.currentTime),s.connect(o),o.connect(this.audioContext.destination),!0===e&&(s.loop=!0),s.start(0)}playBgmAtFirstTime(t){null===this.bgm&&(this.playAudioBuffer(this.audio.bgm,.3,!0),this.bgm=t)}play(t){t in this.audio&&this.playAudioBuffer(this.audio[t],.2)}}var a=e.p+"153c34eacbc748a364e3523688261f90.png";class c{constructor(){this.virutalCanvas={},this.colors=7,this.colorPosition={red:0,blue:1,yellow:2,green:3,cyan:4,orange:5,purple:6,gray:7}}async load(){this.blockImage=await this.loadImage(a)}loadImage(t){return new Promise((function(i){const e=new Image;e.src=t,e.onload=function(){i(e)}}))}prerenderSkin(t){let i=document.createElement("canvas");i.height=t,i.width=t*this.colors,i.getContext("2d").drawImage(this.blockImage,0,0,t*this.colors,t),this.virutalCanvas[t]=i}drawBlock(t,i,e,s,o,n){s in this.virutalCanvas||this.prerenderSkin(s);const h=this.virutalCanvas[s],r=this.colorPosition[o];t.save(),n<1&&(t.globalAlpha=n),t.drawImage(h,r*s,0,s,s,i,e,s,s),t.restore()}}e(0);var u=new class{constructor(){this.sound=new l,this.image=new c}load(){return Promise.all([this.sound.load(),this.image.load()])}};function d(t,i,e,s){return e*((t=t/s-1)*t*t*t*t+1)+i}function g(t){let i=null,e=null,s=null,o=null;for(let n of t){const t=n[0],h=n[1];(null==i||t<i)&&(i=t),(null==e||t>e)&&(e=t),(null==s||h<s)&&(s=h),(null==o||h>o)&&(o=h)}return[i,e,s,o]}var f=new class{constructor(){this.dpr=window.devicePixelRatio||1,this.uiCanvas=document.getElementById("ui"),this.spriteCanvas=document.getElementById("game"),this.animationCanvas=document.getElementById("animation"),this.overlayCanvas=document.getElementById("overlay"),this.ui=this.uiCanvas.getContext("2d"),this.sprite=this.spriteCanvas.getContext("2d"),this.animation=this.animationCanvas.getContext("2d"),this.overlay=this.overlayCanvas.getContext("2d")}refreshViewPort(t){t&&this.setUpAllCanvas();const i=(s=" -webkit- -moz- -o- -ms- ".split(" "),!!("ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch)||(e=["(",s.join("touch-enabled),("),"heartz",")"].join(""),window.matchMedia(e).matches));var e,s;return{width:this.uiCanvas.width,height:this.uiCanvas.height,isTouch:i,dpr:this.dpr}}clearAll(){const t=this.spriteCanvas.width,i=this.spriteCanvas.height;this.sprite.clearRect(0,0,t,i),this.ui.clearRect(0,0,t,i),this.animation.clearRect(0,0,t,i),this.overlay.clearRect(0,0,t,i)}setUpAllCanvas(){this.setUpCanvas(this.uiCanvas),this.setUpCanvas(this.spriteCanvas),this.setUpCanvas(this.animationCanvas),this.setUpCanvas(this.overlayCanvas)}setUpCanvas(t){let i=+getComputedStyle(t).getPropertyValue("height").slice(0,-2),e=+getComputedStyle(t).getPropertyValue("width").slice(0,-2);t.height=i*this.dpr,t.width=e*this.dpr}};const p=22,m=10,b=500,k=2;class y{onGameEvent(t){}keyControl(t,i){if(!(t in this.keyMap))return;const e=this.keyMap[t];if("down"==i){let t=1;if(e in this.keyPressed&&1==this.keyPressed[e]&&(t=0),this.callback(e),this.keyPressed[e]=1,("left"==e||"right"==e||"down"==e)&&t){const t=this;clearTimeout(this.keyTimer[e]),this.keyTimer[e]=setTimeout((function i(){1==t.keyPressed[e]&&(t.callback(e),setTimeout(i,30))}),250)}}else this.keyPressed[e]=0,clearTimeout(this.keyTimer[e]),this.keyTimer[e]=null}install(t){this.keyPressed={},this.keyTimer={},this.callback=t,this.keyMap={ArrowLeft:"left",ArrowRight:"right",ArrowDown:"down",ArrowUp:"clockwise",Space:"hard_drop",MetaLeft:"hold",KeyX:"regret"};let i=this;document.addEventListener("keydown",t=>{i.keyControl(t.code,"down")}),document.addEventListener("keyup",t=>{i.keyControl(t.code,"up")})}}class w{onGameEvent(t){"lockblock"==t&&this.clearTouch()}clearTouch(){this.ongoingTouches=[],this.touchNoMove=[],this.ongoingTouchesStart=[],this.touchTrace=[],this.ongoingTouchesTime=[]}indexForOngoingTouch(t){const i=t.identifier;for(let t=0;t<this.ongoingTouches.length;t++)if(this.ongoingTouches[t].identifier==i)return t;return null}onTouchStart(t,i){i("touch");var e=t.changedTouches;for(let t=0;t<e.length;t++){let i=e[t];this.ongoingTouches.push(i),this.ongoingTouchesStart.push(i),this.touchNoMove.push(!0),this.touchTrace.push([]),this.ongoingTouchesTime.push(Date.now())}}onTouchMove(t,i){var e=t.changedTouches;for(let t=0;t<e.length;t++){let s=e[t];const o=this.indexForOngoingTouch(s);if(null!=o){const t=s.pageY-this.ongoingTouches[o].pageY,e=s.pageX-this.ongoingTouches[o].pageX;let n=null;Math.abs(e)>Math.abs(t)&&e<-18?n="left":Math.abs(e)>Math.abs(t)&&e>18?n="right":Math.abs(t)>Math.abs(e)&&t>18&&(n="down"),null!==n&&(this.ongoingTouches[o]=s,this.touchNoMove[o]=!1,i(n));const h=Date.now();this.touchTrace[o].push([h-this.ongoingTouchesTime[o],[e,t]]),this.ongoingTouchesTime[o]=h}}}onTouchEnd(t,i){var e=t.changedTouches;for(let t=0;t<e.length;t++){let s=e[t];const o=this.indexForOngoingTouch(s);if(null!=o){const t=s.pageY-this.ongoingTouchesStart[o].pageY,e=s.pageX-this.ongoingTouchesStart[o].pageX;if(Math.abs(e)<=18&&Math.abs(t)<=18&&this.touchNoMove[o])i("clockwise");else{let t=0,e=[0,0],s=[0,0],n=0;for(let i=this.touchTrace[o].length-1;i>=0;i--)if(s[0]+=this.touchTrace[o][i][1][0],s[1]+=this.touchTrace[o][i][1][1],n+=this.touchTrace[o][i][0],n>0){let i=Math.sqrt(s[0]**2+s[1]**2)/n;i>t&&(t=i,e[0]=s[0],e[1]=s[1])}t>1.2&&Math.abs(e[1])>Math.abs(e[0])&&e[1]>1.3*18?i("hard_drop"):t>1.2&&e[1]<-36&&Math.abs(e[1])>Math.abs(e[0])&&i("regret")}this.ongoingTouches.splice(o),this.touchNoMove.splice(o),this.ongoingTouchesStart.splice(o),this.touchTrace.splice(o),this.ongoingTouchesTime.splice(o)}}}install(t){this.clearTouch();const i=this;document.addEventListener("touchstart",e=>{i.onTouchStart(e,t)}),document.addEventListener("touchmove",e=>{i.onTouchMove(e,t)}),document.addEventListener("touchend",e=>{i.onTouchEnd(e,t)}),document.addEventListener("touchcancel",e=>{i.onTouchEnd(e,t)})}}class v{constructor(t,i,e){this.rows=p+k,this.cols=m,this.newState=this.createEmptyField(),this.relocate(t,i,e)}createEmptyField(){let t=[];for(let i=0;i<this.rows;i++){let i=new Array(this.cols);for(let t=0;t<this.cols;t++)i[t]=null;t.push(i)}return t}setBlockField(t,i,e,s){this.newState=this.createEmptyField();for(let t of i)this.newState[t[0]][t[1]]=[e,.2];for(let i of t)this.newState[i[0]][i[1]]=[e,1];for(let t=0;t<this.rows;t++)for(let i=0;i<this.cols;i++)null!==s[t][i]&&(this.newState[t][i]=[s[t][i],1])}relocate(t,i,e){this.x=t,this.y=i,this.blockSize=e,this.lastState=this.createEmptyField()}setRedrawLines(t){for(let i of t)for(let t=0;t<this.cols;++t)this.lastState[i][t]=null}clear(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.cols;i++){const e=this.lastState[t][i],s=this.newState[t][i];null==e&&null==s||null!=e&&null!=s&&e[0]==s[0]&&e[1]==s[1]||this.clearBlock(t,i)}}draw(){for(let t=0;t<this.rows;t++)for(let i=0;i<this.cols;i++){const e=this.lastState[t][i],s=this.newState[t][i];null==e&&null==s||null!=e&&null!=s&&e[0]==s[0]&&e[1]==s[1]||null!=s&&this.drawBlock(t,i,s[0],s[1])}this.lastState=this.newState}clearBlock(t,i){if(t<2)return;const e=i*this.blockSize+this.x,s=(t-2)*this.blockSize+this.y;f.sprite.clearRect(e,s,this.blockSize,this.blockSize)}drawBlock(t,i,e,s){if(t<2)return;const o=i*this.blockSize+this.x,n=(t-2)*this.blockSize+this.y;u.image.drawBlock(f.sprite,o,n,this.blockSize,e,s)}}class T{constructor(t,i,e,s,o){this.title=o,this.relocate(t,i,e,s)}relocate(t,i,e,s){this.x=t,this.y=i,this.width=e,this.height=s,this.textDirty=!0,this.uiDirty=!0}clear(){if(this.uiDirty){f.ui.clearRect(this.x,this.y,this.width,this.height)}if(this.textDirty){f.sprite.clearRect(this.x,this.y,this.width,this.height)}}draw(){if(this.uiDirty){let t=f.ui;t.save(),t.fillStyle="rgb(0,0,0,0.85)",t.fillRect(this.x,this.y,this.width,this.height),t.restore(),this.uiDirty=!1}if(this.textDirty){let t=f.sprite;t.save(),t.fillStyle="white",t.font=this.height+1+"px pixeboy",t.fillText(this.title,this.x,this.y+this.height),t.restore(),this.textDirty=!1}}}class S{constructor(t,i,e,s,o,n,h){this.titleBar=new T(t,i,e,o,n),this.content=h,this.relocate(t,i,e,s,o)}setContent(t){t!==this.content&&(this.content=t,this.contentDirty=!0)}relocate(t,i,e,s,o){this.x=t,this.y=i,this.width=e,this.height=s,this.titleHeight=o,this.uiDirty=!0,this.contentDirty=!0,this.titleBar.relocate(t,i,e,o)}clear(){if(this.titleBar.clear(),this.uiDirty){f.ui.clearRect(this.x,this.y+this.titleHeight,this.width,this.height-this.titleHeight)}if(this.contentDirty){f.sprite.clearRect(this.x,this.y+this.titleHeight,this.width,this.height-this.titleHeight)}}draw(){if(this.titleBar.draw(),this.uiDirty){let t=f.ui;t.save(),t.fillStyle="rgb(0,0,0,0.6)",t.fillRect(this.x,this.y+this.titleHeight,this.width,this.height-this.titleHeight),t.restore(),this.uiDirty=!1}if(this.contentDirty){let t=f.sprite;t.save(),t.fillStyle="white",t.font=this.calculateFontSize(this.content)+"px ka1",t.fillText(this.content,this.x+2,this.y+2*this.titleHeight),this.contentDirty=!1,t.restore()}}calculateFontSize(t){const i=f.sprite;let e=this.titleHeight-3;for(;e>3;){if(i.font=e+"px ka1",i.measureText(t).width+5<this.width)break;e-=1}return e}}class x{constructor(t,i,e,s,o){this.relocate(t,i,e,s,o)}relocate(t,i,e,s,o){this.x=t,this.y=i,this.width=e,this.height=s,this.blockSize=o,this.dirty=!0}clear(){if(this.dirty){f.ui.fillRect(this.x,this.y,this.width,this.height)}}draw(){if(this.dirty){const t=f.ui;t.save(),t.fillStyle="rgb(0,0,0,1.0)",t.fillRect(this.x,this.y,this.width,this.height),t.strokeStyle="rgb(30,30,30)",t.lineWidth=2,t.beginPath();for(let i=1;i<m;++i)t.moveTo(this.x+i*this.blockSize,this.y),t.lineTo(this.x+i*this.blockSize,this.height+this.y);for(let i=1;i<p;++i)t.moveTo(this.x,this.y+i*this.blockSize),t.lineTo(this.x+this.width,this.y+i*this.blockSize);t.stroke(),t.restore(),this.dirty=!1}}}class C{constructor(t,i,e,s,o,n,h){this.panel=new S(t,i,e,s,o,n,""),this.title=n,this.relocate(t,i,e,s,o),this.setBlocks(h)}setBlocks(t){let i=!1;if(this.blocks&&t.length==this.blocks.length){for(let e=0;e<this.blocks.length;e++)if(t[e]!=this.blocks[e]){i=!0;break}}else i=!0;if(i){this.blocks=[];for(let i of t)this.blocks.push(i);this.blockDirty=!0}}relocate(t,i,e,s,o){this.panel.relocate(t,i,e,s,o),this.x=t,this.y=i,this.width=e,this.height=s,this.titleHeight=o,this.blockDirty=!0}clear(){this.panel.clear(),this.blockDirty&&f.sprite.clearRect(this.x,this.y+this.titleHeight,this.width,this.height-this.titleHeight)}draw(){this.panel.draw(),this.blockDirty&&(f.sprite.save(),this.drawBlocks(),this.blockDirty=!1,f.sprite.restore())}drawBlocks(){const t=Math.round(.8*this.width/4),i=Math.round((this.height-this.titleHeight)/this.blocks.length*.85/2),e=Math.min(t,i),s=Math.round((this.height-this.titleHeight)/this.blocks.length);for(let t=0;t<this.blocks.length;t++){const i=this.blocks[t],o=i.positions(0,0,0),[n,h,r,l]=g(o),a=(l-r+1)*e,c=(h-n+1)*e,d=Math.round((this.width-a)/2),p=Math.round((s-c)/2),m=this.x,b=this.y+this.titleHeight+t*s;for(let t=0;t<o.length;++t){let s=(o[t][1]-r)*e+m+d,h=(o[t][0]-n)*e+b+p;u.image.drawBlock(f.sprite,s,h,e,i.style,1)}}}}class M{constructor(t,i,e,s,o){this.progress=0,this.duration=o,this.rank=[],this.score=0,this.clearCount=0,this.endTime="",this.visible=!1,this.dirty=!0,this.relocate(t,i,e,s)}relocate(t,i,e,s){this.width=e,this.height=s,this.x=t,this.y=i,this.dirty=!0}setVisible(t){!t&&this.visible&&(this.progress=0),this.visible=t,this.dirty=!0}setRank(t,i,e,s){this.rank=t,this.score=i,this.clearCount=e,this.endTime=s}clear(){if(this.dirty){f.overlay.clearRect(this.x,Math.round(.8*this.y),this.width,Math.round(1.2*this.height)),this.visible||(this.dirty=!1)}}drawRankList(t,i,e,s,o,n,h){const r=this.rank,l=Math.round(.08*o);t.font=l+"px pixeboy";const a=Math.round(i+s/2);let c=!1;const u=Math.min(10,r.length),d=Math.round(1.27*e);for(let i=0;i<u;++i){let e=r[i];r[i].score==this.score?(c=!0,t.fillStyle="rgba(200,0,0,"+h/n+")"):t.fillStyle="rgba(255,255,255,"+h/n+")",t.textAlign="right",t.fillText(e.score,a-.35*o,d+l*i),t.textAlign="left",t.fillText(e.clearLine,a-.25*o,d+l*i),t.textAlign="left",t.fillText(e.playedAt,a,d+l*i)}c||(t.fillStyle="rgba(200,0,0,"+h/n+")",t.textAlign="right",t.fillText(this.score,a-.35*o,d+l*u),t.textAlign="left",t.fillText(this.clearCount,a-.25*o,d+l*u),t.textAlign="left",t.fillText(this.endTime,a,d+l*u))}draw(){if(this.visible&&this.dirty){const t=f.overlay,i=this.height*(this.progress/this.duration),e=this.progress/this.duration*.8,s=Math.round(.12*i),o=this.y+Math.round((this.height-i)/2);t.save(),t.fillStyle="rgba(50,50,50,"+e+")",t.fillRect(this.x,o,this.width,i),this.progress>20&&(t.font=s+"px ka1",t.fillStyle="rgba(251,226,81,"+(this.progress-20)/(this.duration-20)+")",t.textAlign="center",t.fillText("GAME OVER",Math.round(this.width/2),Math.round(1.05*o))),this.progress>10&&this.drawRankList(t,0,o,this.width,i,this.duration-10,this.progress-10),this.progress<this.duration?this.progress+=1:this.dirty=!1,t.restore()}}}class B{constructor(t){this.board=new x(0,0,0,0,0),this.blockField=new v(0,0,0),this.previewPanel=new C(0,0,0,0,0,"next",[]),this.scorePanel=new S(0,0,0,0,0,"score",""),this.clearLinePanel=new S(0,0,0,0,0,"lines",""),this.timePanel=new S(0,0,0,0,0,"time",""),this.regretPanel=new S(0,0,0,0,0,"regret",""),this.holdPanel=new C(0,0,0,0,0,"hold",[]),this.rankList=new M(0,0,0,0,30),this.children=[this.blockField,this.board,this.scorePanel,this.clearLinePanel,this.timePanel,this.regretPanel,this.previewPanel,this.holdPanel,this.rankList],this.relocate(t)}relocate(t){const i=Math.round(1.4*m)/p;let e,s=!1;t.height*i<t.width?e=Math.round(.95*t.height/p):(e=Math.round(.95*t.width/1.4/m),s=!0);const o=e*m,n=e*p,h=Math.round((t.width-1.4*o)/2);let r;r=s&&t.isTouch?Math.round((t.height-n)/7):Math.round((t.height-n)/2),this.board.relocate(h,r,o,n,e),this.blockField.relocate(h,r,e);const l=Math.round(n/30),a=h+o,c=Math.round(.4*o),u=r,d=Math.round(.33*t.height);this.previewPanel.relocate(a,u,c,d+l,l);const g=u+l+d,f=Math.round(.05*t.height);this.scorePanel.relocate(a,g,c,f+l,l);const b=g+l+f;this.clearLinePanel.relocate(a,b,c,f+l,l);const k=b+l+f;this.timePanel.relocate(a,k,c,f+l,l);const y=k+f+l;this.regretPanel.relocate(a,y,c,f+l,l);const w=y+f+l,v=Math.round(.15*t.height);this.holdPanel.relocate(a,w,c,v+l,l);const T=Math.round(.5*n);this.rankList.relocate(0,Math.round((t.height-T)/2),t.width,T),this.gameX=h,this.gameY=r,this.gameWidth=o,this.gameHeight=n,this.blockSize=e}showRankList(){this.rankList.setVisible(!0)}hideRankList(){this.rankList.setVisible(!1)}clear(){for(let t of this.children)t.clear()}draw(){for(let t of this.children)t.draw()}setGameStates(t){const i=t;this.blockField.setBlockField(i.getBlockPositions(),i.getPredictedPositions(),i.getBlockStyle(),i.getStack()),this.scorePanel.setContent(i.getScore()),this.clearLinePanel.setContent(i.getLineCount()),this.timePanel.setContent(i.getUsedTime()),this.regretPanel.setContent(i.getRegretCount()),this.previewPanel.setBlocks(i.getNextBlocks()),this.holdPanel.setBlocks(i.getHold()),this.rankList.setRank(i.getScoreRank(),i.getScore(),i.getLineCount(),i.getEndTime())}}class P{constructor(t,i,e){this.shapes=t,this.style=e,this.kickTable=null,"other"==i?this.kickTable={0:{1:[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]],3:[[0,0],[1,0],[1,1],[0,-2],[1,-2]]},1:{2:[[0,0],[1,0],[1,-1],[0,2],[1,2]],0:[[0,0],[1,0],[1,-1],[0,2],[1,2]]},2:{3:[[0,0],[1,0],[1,1],[0,-2],[1,-2]],1:[[0,0],[-1,0],[-1,1],[0,-2],[-1,-2]]},3:{0:[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]],2:[[0,0],[-1,0],[-1,-1],[0,2],[-1,2]]}}:"I"==i&&(this.kickTable={0:{1:[[0,0],[-2,0],[1,0],[-2,-1],[1,2]],3:[[0,0],[-1,0],[2,0],[-1,2],[2,-1]]},1:{2:[[0,0],[-1,0],[2,0],[-1,2],[2,-1]],0:[[0,0],[2,0],[-1,0],[2,1],[-1,-2]]},2:{3:[[0,0],[2,0],[-1,0],[2,1],[-1,-2]],1:[[0,0],[1,0],[-2,0],[1,-2],[-2,1]]},3:{0:[[0,0],[1,0],[-2,0],[1,-2],[-2,1]],2:[[0,0],[-2,0],[1,0],[-2,-1],[1,2]]}}),this.offsets=[],this.boundingBoxWidth=t[0][1].length;for(let i=0;i<t.length;++i){const e=t[i],s=[];for(let t=0;t<e.length;++t)for(let i=0;i<e[t].length;++i)1==e[t][i]&&s.push([t,i]);this.offsets.push(s)}}getRotationNumber(t){let i;return i=t<0?(4- -t%4)%4:t%4,i}positions(t,i,e){let s=this.getRotationNumber(e);const o=this.offsets[s];let n=[];for(let e=0;e<o.length;++e){let s=o[e];n.push([t+s[0],i+s[1]])}return n}collide(t,i,e,s){const o=this.positions(i,e,s);for(let i=0;i<o.length;++i){const e=o[i];if(e[0]<0||e[1]<0||e[0]>=t.length||e[1]>=t[e[0]].length)return!0;if(null!==t[e[0]][e[1]])return!0}return!1}rotate(t,i,e,s,o){const n=this.getRotationNumber(s),h=this.getRotationNumber(s+o);if(null==this.kickTable)return this.collide(t,i,e,h)?[i,e,n]:[i,e,h];const r=this.kickTable[n][h];for(let s in r){const o=r[s];if(!this.collide(t,i-o[1],e+o[0],h))return[i-o[1],e+o[0],h]}return[i,e,n]}move(t,i,e,s,o){let n=i,h=e,r=s;if("clockwise"==o)return this.rotate(t,i,e,s,1);if("counter_clockwise"==o)return this.rotate(t,i,e,s,-1);if("left"==o)h-=1;else if("right"==o)h+=1;else if("down"==o)n+=1;else if("hard_drop"==o){let o=this.positions(i,e,s),h=t.length-1;for(let i=0;i<o.length;++i){let e=o[i][1],s=o[i][0];h=Math.min(h,t.length-s-1);for(let i=s+1;i<t.length;++i)if(null!==t[i][e]){let t=i-s-1;h=Math.min(t,h);break}}n+=h}return this.collide(t,n,h,r)?[i,e,s]:[n,h,r]}}let R=new P([[[1,0,0],[1,1,1],[0,0,0]],[[0,1,1],[0,1,0],[0,1,0]],[[0,0,0],[1,1,1],[0,0,1]],[[0,1,0],[0,1,0],[1,1,0]]],"other","blue"),F=new P([[[1,1,0],[0,1,1],[0,0,0]],[[0,0,1],[0,1,1],[0,1,0]],[[0,0,0],[1,1,0],[0,1,1]],[[0,1,0],[1,1,0],[1,0,0]]],"other","red"),L=new P([[[0,0,1],[1,1,1],[0,0,0]],[[0,1,0],[0,1,0],[0,1,1]],[[0,0,0],[1,1,1],[1,0,0]],[[1,1,0],[0,1,0],[0,1,0]]],"other","orange"),I=new P([[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],[[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]],[[0,0,0,0],[0,0,0,0],[1,1,1,1],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]]],"I","cyan"),z=new P([[[0,1,1,0],[0,1,1,0],[0,0,0,0]],[[0,1,1,0],[0,1,1,0],[0,0,0,0]],[[0,1,1,0],[0,1,1,0],[0,0,0,0]],[[0,1,1,0],[0,1,1,0],[0,0,0,0]]],null,"yellow"),D=new P([[[0,1,0],[1,1,1],[0,0,0]],[[0,1,0],[0,1,1],[0,1,0]],[[0,0,0],[1,1,1],[0,1,0]],[[0,1,0],[1,1,0],[0,1,0]]],"other","purple"),A=new P([[[0,1,1],[1,1,0],[0,0,0]],[[0,1,0],[0,1,1],[0,0,1]],[[0,0,0],[0,1,1],[1,1,0]],[[1,0,0],[1,1,0],[0,1,0]]],"other","green");class E{constructor(t,i,e){this.rows=p+k,this.cols=m,this.candidates=[R,F,L,I,z,D,A],this.startLevel=1,this.onLockBlock=t||(()=>{}),this.onGameOver=i||(()=>{}),this.onHarddrop=e||(()=>{}),this.storage=window.localStorage,this.reset()}createEmptyStack(){let t=[];for(let i=0;i<this.rows;i++){let i=new Array(this.cols);for(let t=0;t<this.cols;++t)i[t]=null;t.push(i)}return t}reset(){this.stack=this.createEmptyStack(),this.block=null,this.blockRow=null,this.blockCol=null,this.tspin=!1,this.rotation=null,this.nextBlocks=[],this.hold=null,this.holdTime=0,this.beginTime=null,this.endTime=null,this.randomBlocks=[],this.history=[],this.score=0,this.combo=0,this.regretCount=5,this.lineCount=0,this.level=this.startLevel,this.levelClearCount=0}addSnapshot(){let t={stack:(i=this.stack,JSON.parse(JSON.stringify(i))),block:this.block,blockRow:this.blockRow,blockCol:this.blockCol,tspin:this.tspin,rotation:this.rotation,nextBlocks:this.nextBlocks.slice(),hold:this.hold,holdTime:this.holdTime,randomBlocks:this.randomBlocks.slice(),score:this.score,combo:this.combo,lineCount:this.lineCount,level:this.level,levelClearCount:this.levelClearCount};var i;this.history.push(t),this.history.length>10&&this.history.shift()}rewind(){if(0==this.history.length)return!1;let t=this.history.pop();for(let i in t)this[i]=t[i];return this.resetDelayTimer(),this.resetFallTimer(),!0}restart(){this.reset(),this.beginTime=Date.now(),this.endTime=null,this.nextBlocks=[this.pickBlock(),this.pickBlock(),this.pickBlock()],this.triggerNextDrop()}getScore(){return this.score}getHold(){return null===this.hold?[]:[this.hold]}getNextBlocks(){return this.nextBlocks}getLineCount(){return this.lineCount}getRegretCount(){return this.regretCount}getEndTime(){return this.endTime?(t=new Date(this.endTime),i=t.getHours(),e=t.getMinutes(),s=i+":"+(e=e<10?"0"+e:e),t.getFullYear()+"/"+(t.getMonth()+1)+"/"+t.getDate()+"  "+s):null;var t,i,e,s}getUsedTime(){if(null==this.beginTime)return"";let t;return t=this.endTime?this.endTime:Date.now(),function(t){parseInt(t%1e3/100);let i=Math.floor(t/1e3%60),e=Math.floor(t/6e4%60),s=Math.floor(t/36e5%24);return s=s<10?"0"+s:s,e=e<10?"0"+e:e,i=i<10?"0"+i:i,s+":"+e+":"+i}(t-this.beginTime)}triggerNextDrop(){this.state="dropping",this.tspin=!1,this.isPerfect=!1,this.fullLines=[],this.holdTime=0,this.nextBlocks.push(this.pickBlock()),this.resetDelayTimer(),this.resetFallTimer(),this.spawnNewBlock(this.nextBlocks.shift())?this.addSnapshot():(this.state="over",this.endTime=Date.now(),this.stopFallTimer(),this.updateScoreRank(),this.onGameOver())}isOver(){return"over"==this.state}cannotFall(){return!(null==this.block||!this.block.collide(this.stack,this.blockRow+1,this.blockCol,this.rotation))}spawnNewBlock(t){this.block=t;const i=Math.floor(this.cols/2),e=this.block.boundingBoxWidth;return this.blockRow=1,this.blockCol=i-Math.ceil(e/2),this.rotation=0,!this.block.collide(this.stack,this.blockRow,this.blockCol,this.rotation)||(this.block=null,this.blockCol=null,this.blockRow=null,this.rotation=null,!1)}move(t){if(this.tspin=!1,null==this.block)return null;const i=this.block.move(this.stack,this.blockRow,this.blockCol,this.rotation,t),e=i[0]-this.blockRow,s=i[0],o=i[1],n=i[2];let h="normal";if(s==this.blockRow&&o==this.blockCol&&n==this.rotation)h="stuck";else if(("clockwise"==t||"counter_clockwise"==t)&&this.block==D){let t=[[s,o],[s+2,o],[s,o+2],[s+2,o+2]],i=0;for(let e of t)e[0]<0||e[0]>=this.rows||e[1]<0||e[1]>=this.cols||null!=this.stack[e[0]][e[1]]&&(i+=1);i>=3&&(h="tspin",this.tspin=!0)}return this.blockRow=s,this.blockCol=o,this.rotation=n,{newRow:s,newCol:o,newRotation:n,dropStep:e,moveType:h}}getFullLines(){let t=[],i=!0;for(let e=0;e<this.rows;e++)this.stack[e].every(t=>null!==t)?t.push(e):i=!1;return[t,i]}getPredictedPositions(){if(null==this.block)return[];const t=this.block.move(this.stack,this.blockRow,this.blockCol,this.rotation,"hard_drop");return this.block.positions(t[0],t[1],t[2])}clearLines(){const t=this.fullLines,i=this.isPerfect,e=this.tspin;this.updateClearLineScore(t.length,i,e),t.sort();for(let i=t.length-1;i>=0;i--)this.stack.splice(t[i],1);for(let i=0;i<t.length;i++){let t=new Array(this.cols);for(let i=0;i<this.cols;++i)t[i]=null;this.stack.unshift(t)}this.fullLines=[],this.isPerfect=!1,this.tspin=!1}stopFallTimer(){clearTimeout(this.fallTimerId)}dropSpeed(){return 1e3*Math.pow(.8-.007*(this.level-1),this.level-1)}resetFallTimer(){this.stopFallTimer();const t=this.dropSpeed(),i=this;this.fallTimerId=setTimeout((function(){i.control("fall"),i.resetFallTimer()}),t)}lockBlock(){this.stopFallTimer();let t=this.block.positions(this.blockRow,this.blockCol,this.rotation);for(let i of t)this.stack[i[0]][i[1]]=this.block.style;this.block=null,this.blockRow=null,this.blockCol=null,this.rotation=null;const i=this.getFullLines();this.isPerfect=i[1],this.fullLines=i[0],this.state="locked",this.onLockBlock(t,this.fullLines,this.isPerfect,this.tspin)}resetDelayTimer(){clearTimeout(this.lockDelayTimer);const t=this;this.lockDelayTimer=setTimeout((function(){t.cannotFall()&&t.lockBlock()}),b)}pickBlock(){if(0==this.randomBlocks.length){for(let t in this.candidates)this.randomBlocks.push(this.candidates[t]);!function(t){for(let i=t.length-1;i>0;i--){let e=Math.floor(Math.random()*(i+1)),s=t[i];t[i]=t[e],t[e]=s}}(this.randomBlocks)}return this.randomBlocks.shift()}getBlockStyle(){return this.block?this.block.style:null}getStack(){return this.stack}getBlock(){return this.block}getBlockPositions(){return this.block?this.block.positions(this.blockRow,this.blockCol,this.rotation):[]}control(t){if("dropping"==this.state&&"hold"!=t&&"regret"!=t){let i=null;"down"==t?i="soft":"hard_drop"==t&&(i="hard"),"fall"==t&&(t="down");const e=this.move(t);"stuck"!=e.moveType&&this.resetDelayTimer(),this.updateDropScore(e.dropStep,i),"hard_drop"==t&&(this.onHarddrop(this.getBlockPositions()),this.lockBlock())}else if("dropping"==this.state&&"hold"==t)if(0==this.holdTime){let t;if(null==this.hold)this.hold=this.block,t=this.nextBlocks.shift(),this.nextBlocks.push(this.pickBlock());else{let i=this.block;t=this.hold,this.hold=i}this.spawnNewBlock(t),this.resetDelayTimer(),this.holdTime=1}else console.log("cannot hold two times");else"dropping"==this.state&&"regret"==t&&(this.regret()||console.log("cannot regret"))}regret(){return this.regretCount>0&&(!!this.rewind()&&(this.regretCount-=1,!0))}updateDropScore(t,i){"soft"==i?this.score+=t:"hard"==i&&(this.score+=2*t)}updateClearLineScore(t,i,e){if(0==t)return this.combo=0,void(e&&(this.score+=400*this.level));this.combo+=1,this.lineCount+=t,this.levelClearCount+=t;let s=0;s=e?[null,800,1200,1600,null][t]:[null,100,300,500,800][t],i&&(s+=[null,800,1e3,1800,200][t]),s*=this.level,this.combo>1&&(s+=this.level*(this.combo-1)*50),4==t&&(this.regretCount+=1),this.levelClearCount>10&&(this.level+=1,this.levelClearCount-=10)}getScoreRank(){let t=this.storage.getItem("score_rank");return null==t?[]:JSON.parse(t)}updateScoreRank(){const t=this.getScore(),i=this.getUsedTime(),e=this.getLineCount();let s=this.getScoreRank();const o=this.getEndTime();s.push({score:t,useTime:i,clearLine:e,playedAt:o}),s.sort((t,i)=>t.score>i.score||t.score==i.score&&t.playedAt>i.playedAt?-1:i.score>t.score||t.score==i.score&&i.playedAt>t.playedAt?1:0),s.length>10&&(s=s.slice(0,10)),this.storage.setItem("score_rank",JSON.stringify(s))}}class U{constructor(t){let i=["rgb(255,29,88)","rgb(24,89,144)","rgb(255,246,133)","rgb(0,221,255)","rgb(0,73,183)"];this.color=i[Math.floor(Math.random()*i.length)],this.size=t,this.progress=0,this.duration=0}setDuration(t){this.duration=t}finished(){return this.progress>=this.duration}boundingBox(t,i){return[t,i,this.size,this.size]}draw(t,i){if(this.finished())return;const e=1-this.progress/this.duration,s=f.animation;s.save(),s.fillStyle=this.color,s.globalAlpha=e,s.fillRect(t,i,this.size,this.size),this.progress+=1,s.restore()}}class N{constructor(){this.particles=[]}boundingBox(){let t=null,i=null,e=null,s=null;for(let o of this.particles){let n=o.x+o.xInitSpeed*o.progress,h=o.y+o.yInitSpeed*o.progress+.01*o.gravity*(o.progress*o.progress),[r,l,a,c]=o.particle.boundingBox(n,h);(null==t||r<t)&&(t=r),(null==i||r+a>i)&&(i=r+a),(null==e||l<e)&&(e=l),(null==s||l+c>s)&&(s=l+c)}return[t,e,i-t+1,s-e+1]}clear(){if(this.particles.length>0){let[t,i,e,s]=this.boundingBox();f.animation.clearRect(t,i,e,s)}}play(){let t=[];for(let i of this.particles)if(i.progress<i.duration){i.progress+=1,t.push(i);let e=i.x+i.xInitSpeed*i.progress,s=i.y+i.yInitSpeed*i.progress+.01*i.gravity*(i.progress*i.progress);i.particle.draw(e,s)}this.particles=t}add(t,i,e,s,o,n,h){const r=2*Math.PI-s%360/360*(2*Math.PI);t.setDuration(h),this.particles.push({particle:t,progress:0,duration:h,gravity:n,x:i,y:e,xInitSpeed:Math.cos(r)*o,yInitSpeed:Math.sin(r)*o})}}class H{constructor(){this.animations=[],this.particles=new N}add(t){t.setManager(this),this.animations.push(t)}play(){for(let t=0;t<this.animations.length;++t){this.animations[t].clear()}this.particles.clear();let t=[];for(let i=0;i<this.animations.length;++i){const e=this.animations[i];e.play(),e.finished()||t.push(e)}this.animations=t,this.particles.play()}}class O{constructor(t,i,e,s,o,n){this.x=t,this.y=i,this.blockSize=e,this.positions=s,this.duration=o,this.progress=1,this.firstPhase=Math.round(.5*this.duration),this.onFinish=n||(()=>{}),this.isFinished=!1,this.manager=null}finished(){return this.isFinished}setManager(t){this.manager=t}clear(){const t=f.animation;for(let i of this.positions){let e=i[1]*this.blockSize+this.x,s=(i[0]-k)*this.blockSize+this.y;t.clearRect(e,s,this.blockSize,this.blockSize)}}play(){if(this.progress>this.duration)return void(this.isFinished||(this.isFinished=!0,this.onFinish&&this.onFinish()));const t=f.animation;t.save();for(let i of this.positions){if(i[0]<k)continue;let e=i[1]*this.blockSize+this.x,s=(i[0]-k)*this.blockSize+this.y;if(this.progress<=this.firstPhase){const i=this.progress/this.firstPhase*.8;t.fillStyle="rgba(255,255,255,"+i+")"}else{const i=.8-(this.progress-this.firstPhase)/(this.duration-this.firstPhase)*.8;t.fillStyle="rgba(255,255,255,"+i+")"}t.fillRect(e,s,this.blockSize,this.blockSize)}t.restore(),this.progress+=1}}class _{constructor(t,i,e,s,o,n){this.x=t,this.y=i,this.blockSize=e,this.positions=s,this.duration=o,this.progress=1,this.onFinish=n||(()=>{}),this.isFinished=!1,this.manager=null,this.boundary=this.getBoundary(t,i,e,s),this.clearBox=[this.boundary[1],i,this.boundary[2]-this.boundary[1],this.boundary[3]-i]}getBoundary(t,i,e,s){let o={},n=0,h=p+k;for(let t of s){const i=t[0],e=t[1];o[e]=e in o?Math.min(i,o[e]):i,n=Math.max(i,n),h=Math.min(i,h)}let r=[];for(let s in o)r.push([i+(o[s]-k)*e,t+s*e]);return r.sort((t,i)=>t[1]-i[1]),[r,r[0][1],r[r.length-1][1]+e,i+(n-k)*e,i+(h-k)*e]}setManager(t){this.manager=t}finished(){return this.isFinished}clear(){f.animation.clearRect(this.clearBox[0],this.clearBox[1],this.clearBox[2],this.clearBox[3])}play(){const t=f.animation;if(this.progress>this.duration)this.isFinished||(this.isFinished=!0,this.onFinish&&(this.clear(),this.onFinish()));else{t.save();for(let i of this.boundary[0]){const e=Math.round(6*this.blockSize);let s=t.createLinearGradient(i[1],this.boundary[4]+Math.round(1.2*this.blockSize),i[1],this.boundary[4]-e+Math.round(1.2*this.blockSize)),o=.6-d(this.progress,.1,.5,this.duration),n=1-this.progress/this.duration;s.addColorStop(o,"rgb(80,80,80,"+n+")"),s.addColorStop(1,"rgb(0,0,0,0)"),t.fillStyle=s;const h=Math.max(this.y,i[0]-e),r=Math.min(i[0]-h,e);t.fillRect(i[1],h,this.blockSize,r)}this.progress+=1,t.restore()}}}class j{constructor(t,i,e,s,o,n){this.x=t,this.y=i,this.width=e,this.height=s,this.duration=o,this.progress=1,this.onFinish=n||(()=>{}),this.isFinished=!1,this.manager=null,this.firstPhase=Math.round(.4*this.duration),this.secondPhase=this.duration-this.firstPhase,this.particleSize=Math.round(.25*this.height)}setManager(t){this.manager=t}finished(){return this.isFinished}clear(){f.animation.clearRect(this.x,this.y,this.width,this.height)}play(){if(this.progress>this.duration)return void(this.isFinished||(this.isFinished=!0,this.onFinish&&this.onFinish()));const t=f.animation;if(this.progress<=this.firstPhase){t.save();const i=this.progress/this.firstPhase;t.fillStyle="rgba(255,255,255,"+i+")",t.restore()}else{this.progress==this.firstPhase+1&&f.sprite.clearRect(this.x,this.y,this.width,this.height);let t=f.animation;t.save();const i=1-(this.progress-this.firstPhase)/this.secondPhase;t.fillStyle="rgba(255,255,255,"+i+")";const e=this.width*(1-(this.progress-this.firstPhase)/this.secondPhase),s=this.x+Math.round((this.width-e)/2);t.fillRect(s,this.y,e,this.height);for(let t=0;t<4;++t)this.manager.particles.add(new U(this.particleSize),s,this.y+Math.round(this.height/2),90+45*Math.random(),10+5*Math.random(),20,35),this.manager.particles.add(new U(this.particleSize),s+e,this.y+Math.round(this.height/2),45+45*Math.random(),10+5*Math.random(),20,35);t.restore()}this.progress+=1}}class G{constructor(t,i){this.animations=[];for(let i of t)this.animations.push(i);this.onFinish=i||(()=>{}),this.isFinished=!1}setManager(t){for(let i of this.animations)i.setManager(t)}finished(){return this.isFinished}clear(){for(let t of this.animations)t.clear()}play(){const t=this.isFinished;if(!t){this.isFinished=!0;for(let t of this.animations)t.play(),t.finished()||(this.isFinished=!1);this.isFinished&&t!=this.isFinished&&this.onFinish()}}}class X{constructor(){this.inputs=[],this.gameUI=null,this.animation=new H,this.tetris=new E((t,i,e,s)=>{let o=i.map(this.createClearLineAnimation.bind(this));this.animation.add(new O(this.gameUI.gameX,this.gameUI.gameY,this.gameUI.blockSize,t,25)),this.animation.add(new G(o,()=>{this.gameUI.blockField.setRedrawLines(i),this.tetris.clearLines(),this.tetris.triggerNextDrop()}))},()=>{this.gameUI.showRankList()},t=>{this.animation.add(new _(this.gameUI.gameX,this.gameUI.gameY,this.gameUI.blockSize,t,40))})}createClearLineAnimation(t){const i=this.gameUI.gameX,e=this.gameUI.gameY+(t-k)*this.gameUI.blockSize,s=this.gameUI.gameWidth,o=this.gameUI.blockSize;return new j(i,e,s,o,26)}installInput(t){const i=this;t.install((function(t){i.control(t)})),this.inputs.push(t)}relocate(t){const i=f.refreshViewPort(t);t&&f.clearAll(),null===this.gameUI?this.gameUI=new B(i):this.gameUI.relocate(i)}draw(){this.gameUI.clear(),this.gameUI.draw()}run(){this.tetris.restart();const t=this;!function i(){t.gameUI.setGameStates(t.tetris),t.draw(),t.animation.play(),requestAnimationFrame(i)}()}control(t){let i={left:1,right:1,down:1,clockwise:1,counter_clockwise:1,hard_drop:1,hold:1,regret:1};this.tetris.isOver()?(this.gameUI.hideRankList(),this.tetris.restart()):(u.sound.playBgmAtFirstTime(1),t in i&&this.tetris.control(t))}}window.addEventListener("load",(function(){u.load().then(()=>{let t=new X;t.relocate(!0),t.installInput(new y),t.installInput(new w),window.addEventListener("resize",(function(){t.relocate(!0)})),t.run()})}))}]);